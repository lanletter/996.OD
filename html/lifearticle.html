<!DOCTYPE html>
<html>

<head>
    <title>生活志文章</title>
    <meta charset="utf-8">
    <!-- 这是个iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览；-->
    <meta content="yes" name="apple-mobile-web-app-capable">
    <!-- 全屏显示-->
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name='viewport'
          content='width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,minimum-scale=1.0'>
    <!-- DNS预解析-->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <link rel="stylesheet" type="text/css" href="../css/video-js.min.css">
    <link rel="stylesheet" type="text/css" href="../css/lifearticle.css">
</head>

<body>
<div id="videobox" class="video">
    <video id="vd" controls preload="auto"
           webkit-playsinline="true" playsinline="true" x-webkit-airplay="true" x5-video-player-type="h5"
           x5-video-player-fullscreen="true" x5-video-ignore-metadata="true">
        <source src="" type="video/mp4">
    </video>
    <button class="play"></button>
</div>
<div id="scroll">
    <header class="header">
        <div class="header__main">
            <hgroup>
                <h3></h3>
            </hgroup>
        </div>
        <div class="header__opt">
            <span class="view-count"><strong></strong></span>
            <span class="comment-count"><strong></strong></span>
            <span class="" id="star"><strong></strong></span>
        </div>
    </header>

    <div class="author">
        <div class="author__title"><span>作者</span></div>
        <div class="authorbox"></div>
    </div>

    <article class="content"></article>

    <div class="bottomdiv"></div>

    <section class="recommend">
        <h3 class="section-title">推荐阅读</h3>
        <ul>

        </ul>
    </section>

    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>
</div>
<script type="text/javascript" src='../js/video.min.js'></script>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src='../js/judge.js'></script>
<script>
    +function ($) {
//        document.writeln("navigator.userAgent: " + navigator.userAgent + "<br />");
//         console.log(navigator.userAgent); 
//        alert(navigator.userAgent);
        if (judge.isBrowser() == true && judge.browser() == "WeiXin") {
            alert("我是微信浏览器");
            var userid = 230374;
            choose();
        } else {
            alert("我是app");
            var userid;
            //app交互—获取userid
            window.onload = function () {
                ft.isLogin2(function (result) {
                    var errorcode = result.errorCode.toString();
                    alert(errorcode);
                    console.log(errorcode);
                    if (errorcode == "1") {
                        userid = result.data.userId.toString();

                        choose();

                    } else if (errorCode == "0") {
                        userid = 1;
                    } else if (errorCode == "-1") {
                        userid = 1;
                    } else if (errorCode == "-2") {
                        userid = 1;
                    }
                });
            };
        }

        function choose() {
            $(function () {
                (function () {
                    var video = $('#videobox video')[0],
                            playBtn = $('#videobox .play');
                    playBtn.on('click', function () {
                        $(this).hide();
                        var vheight = $("#videobox video").height();
                        $('#vd').css({"position": "absolute", "left": "0"});
                        $('#videobox').css({"position": "fixed"});
                        $("#videobox").animate({height: vheight - 1 + "px",}, 1000);
                        $("#scroll").animate({top: vheight - 1,}, 1000);
                        video.play();
                        video.controls = true;
                    });

                    video.addEventListener('ended', function () {
                        playBtn.show();
                        video.controls = false;
                        $('#vd').css({"position": "absolute", "left": "-10rem"});
                        $('#videobox').css({"position": "absolute"});
                        $("#videobox").animate({"height": "10rem"}, 1000);
                        $("#scroll").animate({"top": "10rem"}, 1000);
                    }, false);
                    video.addEventListener('pause', function () {
                        playBtn.hide();
                        video.controls = true;
                    }, false);
                })();

                //获取id
                function GetQueryString(name) {
                    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
                    var r = window.location.search.substr(1).match(reg);
                    if (r != null)return unescape(r[2]);
                    return null;
                }

                var id = GetQueryString("id");
                if (id == null) {
                    id = 439;
                }

                var $header = $('.header'), $content = $('.content');

                $.ajax({
                    url: 'http://121.40.135.115:8080/fotile-api-0.0.2/wantFeel/detail',
                    type: 'POST',
                    data: JSON.stringify({"id": id, "userId": userid}),
                    timeout: 5000, //超时时间
                    contentType: "application/json;charset=utf-8",
                    dataType: 'json', //返回的数据格式：json/xml/html/script/jsonp/text
                    success: function (data, textStatus, jqXHR) {
                        callback(data);
                    },
                    error: function (xhr, textStatus) {
                        console.log('错误');
                        console.log(JSON.stringify(xhr));
                        console.log(JSON.stringify(textStatus))
                    }
                });

                function callback(res) {
                    if (res.status !== 200) {
                        alert(res.errorMessage);
                        return;
                    }
                    var data = res.data;
                    console.log(data);

                    //判断是否收藏
                    if (data.isFavorite == 1) {
                        $("#star").addClass("favorite-count2");
                        $("#star").remove("favorite-count");
                    } else {
                        $("#star").addClass("favorite-count");
                        $("#star").remove("favorite-count2");
                    }

                    /*判断是否有视频*/
                    if(data.video.path==null){
                        $(".play").css("display", "none");
                    }else {
                        $('#videobox').find('#vd').attr('src', data.video.path);
                    }
                    $api.imgAdapt($header.find('.header__main .img'), data.picture.path);
                    $header.find('.header__main h3').text(data.title || data.shortTitle || ' ');
                    $header.find('.view-count strong').text(data.viewCount);
                    $header.find('.comment-count strong').text(data.commentCount);
                    $header.find('#star strong').text(data.favoriteCount);
                    $(".video").css("background-image", 'url("' + data.picture.path + '")');
                    $content.append(data.content);

                    /*title取值*/
                    var txt = data.title;
                    if (txt == undefined) {
                        $('head title').text("生活志");
                    } else {
                        $('head title').text(data.title);
                    }

                    data.cookList.forEach(function (item, index) {
                        var el = $('<div class="clearfix">\
                  <p class="author__info">\
                    <img src="' + item.picture.path + '">\
                    <span>' + item.cookName + '</span>\
                    </p>\
                  <!-- <button class="red-btn add-care" data-follow="' + item.isFollow + '" data-id="' + item.id + '">' + (item.isFollow ? "已关注" : "加关注") + '</button> -->\
                </div>');
                        $('.authorbox').append(el);
                    });

                    data.recommendWantFeelList.forEach(function (item, index) {
                        var el = $('<li class="recommend__info">\
            <a href="' + item.url + '"><img src="' + item.picture.path + '">\
            <div>\
              <h5>' + item.title + '</h5>\
              <span> <i>' + item.tags + '</i>#/<time>' + (new Date(item.createat)).pattern("yyyy.MM.dd") + '</time></span>\
            </div>\
          </a></li>');
                        $('.recommend ul').append(el);
                    });

                    $('.add-care').data('id', data.id).data('follow', false);

                }

                $('.authorbox').on('click', '.add-care', function (e) {
                    var id = $(e.target).data('id'),
                            follow = $(e.target).data('follow');
                    if (follow) {
                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/follow/cookCancel', {
                            "refId": id,
                            "type": 2,
                            "userId": 85507
                        }, function (data) {
                            $(e.target).data('follow', false).text('加关注');
                        });
                    } else {
                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/follow/cook', {
                            "refId": id,
                            "type": 2,
                            "userId": 85507
                        }, function (data) {
                            $(e.target).data('follow', true).text('已关注');
                        });
                    }
                });

                //判断是否收藏
                //app交互——获取登录状态
//                        $('#star').on('click', function (e) {
//                            //alert("id:"+id+"type:"+4+"userid:"+userid);
//                            ft.isLogin(function (result) {
//                                var errorcode = result.errorCode.toString();
//                                if (errorcode == "1") {
//                                    //$api.toast('登陆成功', 2000);
//                                    userid = result.data.userId.toString();
//                                    //alert(userid);
//                                    //收藏
//                                    var follow = $("#star").attr('class');
//                                    if (follow == "favorite-count") {
//                                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/favorite/create', {
//                                            "refId": id,
//                                            "type": 4,
//                                            "userId": userid
//                                        }, function (data) {
//                                            console.log(data);
//                                            console.log("111");
//                                            $("#star").addClass("favorite-count2");
//                                            $("#star").removeClass("favorite-count");
//                                            var oldnum = $("#star strong").text();
//                                            $("#star strong").text(parseInt(oldnum) + 1);
//                                            $api.toast('收藏成功！', 3000);
//                                        });
//                                    } else if (follow == "favorite-count2") {
//                                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/favorite/cancel', {
//                                            "refId": id,
//                                            "type": 4,
//                                            "userId": userid
//                                        }, function (data) {
//                                            console.log(data);
//                                            console.log("222");
//                                            $("#star").removeClass("favorite-count2");
//                                            $("#star").addClass("favorite-count");
//                                            var oldnum = $("#star strong").text();
//                                            $("#star strong").text(parseInt(oldnum) - 1);
//                                            $api.toast('取消收藏！', 3000);
//                                        });
//                                    }
//                                } else if (errorCode == "0") {
//                                    $api.toast('登陆取消', 2000);
//                                } else if (errorCode == "-1") {
//                                    $api.toast('登陆失败', 2000);
//                                } else if (errorCode == "-2") {
//                                    $api.toast('登陆不支持', 2000);
//                                }
//                            });
//                        });

                $('#star').on('click', function (e) {
                    var follow = $("#star").attr('class');
                    if (follow == "favorite-count") {
                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/favorite/create', {
                            "refId": id,
                            "type": 4,
                            "userId": userid
                        }, function (data) {
                            console.log(data);
                            console.log("111");
                            $("#star").addClass("favorite-count2");
                            $("#star").removeClass("favorite-count");
                            var oldnum = $("#star").next().text();
                            $("#star").next().text(parseInt(oldnum) + 1);
                            $api.toast('收藏成功！', 3000);
                            alert('收藏成功！');
                        });
                    } else if (follow == "favorite-count2") {
                        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/favorite/cancel', {
                            "refId": id,
                            "type": 4,
                            "userId": userid
                        }, function (data) {
                            console.log(data);
                            console.log("222");
                            $("#star").addClass("favorite-count");
                            $("#star").removeClass("favorite-count2");
                            var oldnum = $("#star").next().text();
                            $("#star").next().text(parseInt(oldnum) - 1);
                            $api.toast('取消收藏！', 3000);
                            alert('取消收藏！');
                        });
                    }
                });
                //alert("userid:"+userid);
                $.loadComment({
                    "pageNum": 1,
                    "pageSize": 20,
                    "refId": parseInt(id),
                    "type": 4,
                    "userId": parseInt(userid)
                }, 1);
            });
        }

    }(jQuery);
</script>
</body>

</html>
