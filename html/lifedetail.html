<!DOCTYPE html>
<html>

<head>
    <title>生活志话题</title>
    <meta charset="utf-8">
    <meta name='viewport'
          content='width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,minimum-scale=1.0'>
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <link rel="stylesheet" type="text/css" href="../css/lifedetail.css">
</head>

<body>
<div>
    <header class="header">
        <div class="header__main">
            <div class="img"></div>
            <div>
                <a class="click"><img src="../img/invalidName.png"/></a>
                <!--<a class="click"><img src="../img/group14Copy2.png" /></a>-->
            </div>
            <div class="title">
                <h3>

                </h3>
            </div>
            <time class="lifetime"></time>
        </div>
        <div class="header__opt">
            <span class="view-count"><strong></strong></span>
            <span class="comment-count"><strong></strong></span>
            <span class="" id="star"><strong></strong></span>
        </div>
    </header>
    <article class="content">
    </article>
    <div class="active-rule">
        <div class="bottomdiv"></div>
        <h3 class="section-title">活动规则</h3>
        <ul>
        </ul>
    </div>

    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>

</div>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src='../js/judge.js'></script>
<script type="text/javascript" src='../js/url.js'></script>
<script src="../js/alertdiy.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>

<script>
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)return unescape(r[2]);
            return null;
        }
        var id = GetQueryString("id");
        var device = GetQueryString("device");
        if (device == "ios" || device == "android") {
            var userid;
            //app交互—获取userid
            window.onload = function () {
                ft.isLogin2(function (result) {
                    var errorcode = result.errorCode.toString();
                    //alert(errorcode);
                    console.log(errorcode);
                    if (errorcode == "1") {
                        userid = result.data.userId.toString();

                        choose();

                    } else if (errorCode == "0") {
                    } else if (errorCode == "-1") {
                    } else if (errorCode == "-2") {
                    }
                });
            };
        } else if ((device == null)) {
            var userid = 1;
            choose();
        }

        function choose() {
            $(function () {
                var $header = $('.header'),
                        $content = $('.content');
                $.ajax({
                    url: urlport + 'wantFeel/detail',
                    type: 'POST', //GET
                    data: JSON.stringify({"id": id, "userId": userid}),
                    timeout: 5000, //超时时间
                    contentType: "application/json;charset=utf-8",
                    dataType: 'json', //返回的数据格式：json/xml/html/script/jsonp/text
                    success: function (data, textStatus, jqXHR) {
                        callback(data);
                    },
                    error: function (xhr, textStatus) {
                        console.log('错误')
                        console.log(JSON.stringify(xhr))
                        console.log(JSON.stringify(textStatus))
                    }
                })

                function callback(res) {
                    if (res.status !== 200) {
                        alert(res.errorMessage)
                        return;
                    }
                    var data = res.data;
                    console.log(data);

                    //判断是否收藏
                    if(userid==1 || userid=="1"){
                            $("#star").addClass("favorite-count");
                            $("#star").remove("favorite-count2");
                    }else {
                        if (data.isFavorite == 1) {
                            $("#star").addClass("favorite-count2");
                            $("#star").remove("favorite-count");
                        } else {
                            $("#star").addClass("favorite-count");
                            $("#star").remove("favorite-count2");
                        }
                    }

                    $header.find('.header__main h3').text(data.title || data.shortTitle || ' ');
                    $api.imgAdapt($header.find('.header__main .img'), data.picture.path);
                    $header.find('.view-count strong').text(data.viewCount);
                    $header.find('.comment-count strong').text(data.commentCount);
                    $header.find('#star strong').text(data.favoriteCount);
                    if(data.rule==null || data.rule==""){
                        $('.active-rule').css('display','none');
                    }else {
                        $('.active-rule ul').html(data.rule);
                    }

                    /*title取值*/
                    var txt = data.title;
                    if (txt == undefined) {
                        $('head title').text("生活志");
                    } else {
                        $('head title').text(data.title);
                    }

                    /* 时间戳格式转换 */
                    var timestamp = data.createat;

                    function add0(m) {
                        return m < 10 ? '0' + m : m
                    }

                    function format(timestamp) {
                        var time = new Date(timestamp);
                        var year = time.getFullYear();
                        var month = time.getMonth() + 1;
                        var date = time.getDate();
                        var hours = time.getHours();
                        var minutes = time.getMinutes();
                        var seconds = time.getSeconds();
                        return year + '.' + add0(month) + '.' + add0(date);
                    }

                    $header.find('.lifetime').text(format(timestamp));

                    $content.append(data.content);

                    /*微信分享链接专用*/
                    var sharetitle = data.title;
                    var sharedesc;
                    var contents=$content.text().replace(/[\r\n]/g, "").replace(/(^\s+)|(\s+$)/g,"").replace(/\s/g,"");
                    var count = contents.length;
                    if (count > 40) {
                        var nr = contents.substring(0, 40)+"...";
                        sharedesc = nr;
                    }else {
                        sharedesc = contents;
                    }
                    var shareimg = data.picture.path;
                    var sharestr = data.url;
                    var sharelink = sharestr.replace(/api/, "h5");
                    console.log(sharetitle + "|" + shareimg + "|" + sharelink + "|" + sharedesc);
                    $.ajax({
                        type: 'GET',
                        url: urlport+'wx/wxConfig.json?url=' + encodeURIComponent(window.location.href.split('#')[0]),
                        success: function (data) {
                            console.info(data.appId);
                            wx.config({
                                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                                appId: data.appId, // 必填，公众号的唯一标识
                                timestamp: data.timestamp, // 必填，生成签名的时间戳
                                nonceStr: data.nonceStr, // 必填，生成签名的随机串
                                signature: data.signature,
                                jsApiList: [
                                    "onMenuShareTimeline",
                                    "onMenuShareAppMessage",
                                    "onMenuShareQQ",
                                    "onMenuShareWeibo",
                                    "onMenuShareQZone"
                                ]
                            });
                            wx.ready(function () {
                                //分享给朋友圈
                                wx.onMenuShareTimeline({
                                    title: sharetitle, // 分享标题
                                    link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                    imgUrl: shareimg, // 分享图标
                                    success: function () {
                                        // 用户确认分享后执行的回调函数
                                    },
                                    cancel: function () {
                                        // 用户取消分享后执行的回调函数
                                    }
                                });
                                //分享给朋友
                                wx.onMenuShareAppMessage({
                                    title: sharetitle, // 分享标题
                                    desc: contents, // 分享描述
                                    link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                    imgUrl: shareimg, // 分享图标
                                    type: '', // 分享类型,music、video或link，不填默认为link
                                    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                                    success: function () {
                                        // 用户确认分享后执行的回调函数
                                    },
                                    cancel: function () {
                                        // 用户取消分享后执行的回调函数
                                    }
                                });
                            });
                        },
                        error: function (xhr, type) {
                            //alert(111);
                        }
                    })
                }

//                $('#star').on('click', function (e) {
//                    var follow = $("#star").attr('class');
//                    if (follow == "favorite-count") {
//                        $api.post(urlport + 'favorite/create', {
//                            "refId": id,
//                            "type": 5,
//                            "userId": userid
//                        }, function (data) {
//                            console.log(data);
//                            console.log("111");
//                            $("#star").addClass("favorite-count2");
//                            $("#star").removeClass("favorite-count");
//                            var oldnum = $("#star").next().text();
//                            $("#star").next().text(parseInt(oldnum) + 1);
//                            $api.toast('收藏成功！', 3000);
//                        });
//                    } else if (follow == "favorite-count2") {
//                        $api.post(urlport + 'favorite/cancel', {
//                            "refId": id,
//                            "type": 5,
//                            "userId": userid
//                        }, function (data) {
//                            console.log(data);
//                            console.log("222");
//                            $("#star").addClass("favorite-count");
//                            $("#star").removeClass("favorite-count2");
//                            var oldnum = $("#star").next().text();
//                            $("#star").next().text(parseInt(oldnum) - 1);
//                            $api.toast('取消收藏！', 3000);
//                        });
//                    }
//                });
                //app交互——获取登录状态
                $('#star').on('click', function (e) {
                    //alert("id:"+id+"type:"+4+"userid:"+userid);
                    ft.isLogin(function (result) {
                        var errorcode = result.errorCode.toString();
                        if (errorcode == "1") {
                            //$api.toast('登陆成功', 2000);
                            userid = result.data.userId.toString();
                            //alert(userid);
                            //收藏
                            var follow = $("#star").attr('class');
                            if (follow == "favorite-count") {
                                $api.post(urlport+'favorite/create', {
                                    "refId": id,
                                    "type": 5,
                                    "userId": userid
                                }, function (data) {
                                    console.log(data);
                                    console.log("111");
                                    $("#star").addClass("favorite-count2");
                                    $("#star").removeClass("favorite-count");
                                    var oldnum = $("#star strong").text();
                                    $("#star strong").text(parseInt(oldnum) + 1);
                                    $api.toast('收藏成功！', 3000);
                                });
                            } else if (follow == "favorite-count2") {
                                $api.post(urlport+'favorite/cancel', {
                                    "refId": id,
                                    "type": 5,
                                    "userId": userid
                                }, function (data) {
                                    console.log(data);
                                    console.log("222");
                                    $("#star").addClass("favorite-count");
                                    $("#star").removeClass("favorite-count2");
                                    var oldnum = $("#star strong").text();
                                    $("#star strong").text(parseInt(oldnum) - 1);
                                    $api.toast('取消收藏！', 3000);
                                });
                            }
                        } else if (errorCode == "0") {
                            $api.toast('登陆取消', 2000);
                        } else if (errorCode == "-1") {
                            $api.toast('登陆失败', 2000);
                        } else if (errorCode == "-2") {
                            $api.toast('登陆不支持', 2000);
                        }
                    });
                });

                $.loadComment({
                    "pageNum": 1,
                    "pageSize": 30,
                    "type": 5,
                    "refId": parseInt(id),
                    "userId": parseInt(userid)
                }, 1);
            });

        }

</script>
</body>

</html>
