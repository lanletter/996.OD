<!DOCTYPE html>
<html>

<head>
    <title>课程详情</title>
    <meta charset="utf-8">
    <meta name='viewport'
          content='width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,minimum-scale=1.0,telephone=yes'>
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <link rel="stylesheet" type="text/css" href="../css/sitedetail.css">
</head>

<body>
<div>
    <header class="header">
        <div class="header__main">
            <div class="img" style="height: 10rem;"></div>
            <span href='#' class="red-btn buy able buynow">购买 &yen;<b></b></span>
            <h3>

            </h3>
            <span class="red-btn buy dis"></span>
        </div>
        <div class="header__opt">
            <span class="view-count"><i></i><strong></strong></span>
            <span class="comment-count"><strong></strong></span>
        </div>
        <article class="course">
            <p class="course-des">

            </p>
        </article>
    </header>

    <div class="bottomdiv"></div>

    <section class="content">
        <div class="course-info site-info info">
            <div class="clearfix title-box2">
                <h3 class="section-title">课程信息</h3>
                <span id="addToCart">加入购物车 </span>
            </div>
            <div class="course-info-box">
                <ul>
                    <li class="teacher-box">

                    </li>
                    <li class="course-time">
                        <div>
                            <p>
                                <span><time class="course-time-date">10月24日 周二</time></span>
                                <strong>课程日期</strong>
                            </p>
                            <p>
                                <span><time class="course-time-hour">10:00－16:00</time></span>
                                <strong>课程时间</strong>
                            </p>
                        </div>
                    </li>
                    <li class="people-num">
                        <div>
                            <p>
                                <span><b class="overplus"></b>人</span>
                                <strong>剩余人数</strong>
                            </p>
                            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" height='35px'>
                                <line x1="0" y1="35" x2="10" y2="0" style="stroke:#d8dae1;stroke-width:2"/>
                            </svg>
                            <p style="margin-left: 0.7rem">
                                <span><b class="total"></b>人</span>
                                <strong>总人数</strong>
                            </p>
                        </div>
                    </li>
                    <li class="food-type">
                        <div>
                            <p>
                                <span></span>
                                <strong>菜式类别</strong>
                            </p>
                        </div>
                    </li>
                    <li class="address">
                        <div>
                            <p>
                                <span></span>
                                <strong>场馆地址</strong>
                            </p>
                        </div>
                        <a id="sitename"></a>
                        <a href="" id="foo" class="to-map"></a>
                        <!--<form  name="frm"  method="get"  onsubmit = "return foo()" >-->
                        <!--<input  class="to-map" id="foo" type="submit" value=""/>-->
                        <!--</form>-->
                    </li>
                    <li class="tel">
                        <div>
                            <p>
                                <span></span>
                                <strong>场馆电话</strong>
                            </p>
                            <a href="#"><i class="to-call"></i></a>
                        </div>
                    </li>
                    <li class="service-time">
                        <div>
                            <p>
                                <span>全年 <time></time></span>
                                <strong>服务时间</strong>
                            </p>
                        </div>
                    </li>
                    <li class="buy-box">
                        <a href="#" class="buy able buynow">立即购买 &yen;<b></b></a>
                        <span class="dis"></span>
                    </li>
                </ul>
            </div>
        </div>
        <div class="dark-bg"></div>
        <div class="buynow-div">
            <ul class="editlist">
                <li>
                    <img src="" class="titlepic"/>
                    <div class="titletxt">新年家宴本帮菜新年家宴本帮菜新年家宴本帮菜</div>
                </li>
                <li class="boedert">
                    <span>开课时间</span>
                    <p class="time">2017年2月12日 周日 14:00-16:00</p>
                </li>
                <li>
                    <span>开课地点</span>
                    <p class="name">方太生活家上海体验馆</p>
                    <p class="place">上海徐汇区桃江路8号</p>
                </li>
                <li>
                    <span>数量</span>
                    <div class="lightgrey">（剩余：<b>113</b>）</div>
                    <ul class="numbox">
                        <li>
                            <input type="button" value="-"/>
                            <span class="num">1</span>
                            <input type="button" value="+"/>
                        </li>
                    </ul>
                </li>
                <li class="boedert">
                    <span>优惠券：</span>
                    <a href="#" class="coupon" id="selectCoupon">选择优惠券</a>
                    <p style="display: none;border: 1px solid red"><span class="coupontype"></span><span
                            class="couponumber"></span></p>
                </li>
                <li class="boedert">
                    <span>备注：</span>
                    <textarea id="remarks"></textarea>
                    <!--<div class="lightgrey" id="remarks"></div>-->
                    <img src="../img/invalidPen.png" class="editpic">
                </li>
            </ul>
            <div class="ttprice">
                <!--<span id="max">0</span>-->
                <span>¥<b id="allprice">0</b></span>
                <s>¥<b id="oldprice">0</b></s>
                <button class="editbtn" id="purchase">确定</button>
            </div>
            <!--<div class="editarea">-->
            <!--<textarea></textarea>-->
            <!--<button>确定</button>-->
            <!--</div>-->
            <img src="../img/class.png" id="close-div"/>
        </div>
        <div class="bottomdiv"></div>
        <div class="site-pic">
            <h3 class="section-title">菜式图集</h3>
        </div>
    </section>
    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>
</div>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script type="text/javascript">
    //记录是否阻止滚动
    var disableScroll = false;
    //如果弹出对话框时，底层的视图就不让滚动了
    document.addEventListener('touchmove', function(e) {
        if(disableScroll){
            e.preventDefault();
        }
    }, false);
    $(function () {
        var $header = $('.header');
        var $content = $('.content');
        var $buyedit = $('.buynow-div');

        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null)return unescape(r[2]);
            return null;
        }
        var id = GetQueryString("id");
        if (id == null) { id = 675; }
        var userid;

        $api.post('http://121.40.135.115:8080/fotile-api-0.0.2//curriculumn/detail ',
                {id: id},
                function (data) {
                    data = data.data;
                    console.log(data);

                    $("#foo").on("click", function () {
                        var id = data.id;
                        var lng = data.store.lng;
                        var lat = data.store.lat;
                        var sitename = data.store.storeName;
                        var urlstr = "map.html?id=" + id + "&" + "lng=" + lng + "&" + "lat=" + lat + "&" + "sitename=" + sitename;
                        //alert(urlstr);
                        window.location.href = encodeURI(urlstr);
                        //window.location.replace(urlstr);
                        return false;
                    });

                    $api.imgAdapt($header.find('.header__main .img'), data.picture.path);
                    $header.find('h3').text(data.curriculumName);
                    $header.find('.view-count').text(data.viewCount);
                    $header.find('.comment-count strong').text(data.commentCount);
                    $header.find('.favorite-count').text(data.likeCount);
                    $header.find('.course-des').html(data.curriculumDesc);
                    var remaining = parseInt(data.totalCount) - parseInt(data.currentCount);

                    $('.address span').text(data.store.detailAddress);
                    $('.tel span').text(data.store.tel);
                    $('.tel a').attr('href', 'tel:' + data.store.tel);
                    $('.service-time time').text(data.store.serviceTime);
                    $('.overplus').text(remaining);
                    $('.total').text(data.totalCount);
                    $('.food-type span').text(data.styleType);

                    /*title取值*/
                    var txt = data.title;
                    if (txt == undefined) {
                        $('head title').text("课程详情");
                    } else {
                        $('head title').text(data.title);
                    }

                    /* 时间戳格式转换 */
                    var starttime = data.startTime;
                    var endtime = data.endTime;

                    function add0(m) {
                        return m < 10 ? '0' + m : m
                    }

                    function datatime(starttime) {
                        var time = new Date(starttime);
                        var month = time.getMonth() + 1;
                        var date = time.getDate();
                        var week = time.getDay();
                        switch (time.getDay()) {
                            case 0:
                                week = "日";
                                break
                            case 1:
                                week = "一";
                                break
                            case 2:
                                week = "二";
                                break
                            case 3:
                                week = "三";
                                break
                            case 4:
                                week = "四";
                                break
                            case 5:
                                week = "五";
                                break
                            case 6:
                                week = "六";
                                break
                        }
                        ;
                        return add0(month) + '月' + add0(date) + '日 周' + week;

                    }

                    function datatime2(starttime) {
                        var time = new Date(starttime);
                        var year = time.getYear() + 1900;
                        var month = time.getMonth() + 1;
                        var date = time.getDate();
                        var week = time.getDay();
                        switch (time.getDay()) {
                            case 0:
                                week = "日";
                                break
                            case 1:
                                week = "一";
                                break
                            case 2:
                                week = "二";
                                break
                            case 3:
                                week = "三";
                                break
                            case 4:
                                week = "四";
                                break
                            case 5:
                                week = "五";
                                break
                            case 6:
                                week = "六";
                                break
                        }
                        ;
                        return add0(year) + '年' + add0(month) + '月' + add0(date) + '日 周' + week + ' ';

                    }

                    function hourtime(starttime, endtime) {
                        var time = new Date(starttime);
                        var hours = time.getHours();
                        var minutes = time.getMinutes();
                        if (minutes < 10) {
                            minutes = "0" + minutes;
                        }
                        var time2 = new Date(endtime);
                        var hours2 = time2.getHours();
                        var minutes2 = time2.getMinutes();
                        if (minutes2 < 10) {
                            minutes2 = "0" + minutes2;
                        }
                        return hours + ':' + minutes + '-' + hours2 + ':' + minutes2;

                    }

                    $content.find('.course-time-date').text(datatime(starttime));
                    $content.find('.course-time-hour').text(hourtime(starttime, endtime));

                    //app交互——加购物车
                    $("#addToCart").on("click", function () {
                        ft.addToCart({
                            refId: data.id,
                            type: 1,
                            count: 1
                        }, function (result) {
                            var errorcode = result.errorCode.toString();
                            if (errorcode == "1") {
                                $api.toast('加入购物车成功', 2000);
                            } else if (errorcode == "0") {
                                $api.toast('加入购物车取消', 2000);
                            } else if (errorcode == "-1") {
                                $api.toast('加入购物车失败', 2000);
                            } else if (errorcode == "-2") {
                                $api.toast('加入购物车不支持', 2000);
                            }
                        })
                    });
                    //app交互——获取优惠券
                    $("#selectCoupon").on("click", function () {
                        // coupontype = 1;
                        // couponumber = 2222;
                        // alert(coupontype);
                        // alert(couponumber);
                        // $('.coupontype').text(coupontype);
                        // $('.couponumber').text(couponumber);
                        // setmax();
                        ft.selectCoupon(function (result) {
                            var errorcode = result.errorCode.toString();
                            if (errorcode == "1") {
                                $api.toast('获取优惠券成功', 2000);
                                coupontype = result.data.type.toString();
                                couponumber = result.data.number.toString();
//                                alert(coupontype);
//                                alert(couponumber);
                                $('.coupontype').text(coupontype);
                                $('.couponumber').text(couponumber);
                                if (coupontype == "1") {
                                    $('#selectCoupon').text('全额抵扣券');
                                } else if (coupontype == "2") {
                                    $('#selectCoupon').text('300元抵扣券');
                                }
                                setmax();
                            } else if (errorcode == "0") {
                                //alert("获取优惠券取消");
                                $api.toast('获取优惠券取消', 2000);
                                $('#selectCoupon').text('不使用优惠券');
                            } else if (errorcode == "-1") {
                                $api.toast('获取优惠券失败', 2000);
                            } else if (errorcode == "-2") {
                                $api.toast('获取优惠券不支持', 2000);
                            }
                        })
                    });

                    /*数量加减  金额计算*/
                    var oUl = document.getElementsByClassName('numbox')[0];
                    var aLi = oUl.getElementsByTagName('li');
                    var ttbox = document.getElementsByClassName('totalbox')[0];
                    var oldprice = document.getElementById('oldprice');
                    var allprice = document.getElementById('allprice');
                    var coupontype = document.getElementsByClassName('coupontype');
                    var couponumber = document.getElementsByClassName('couponumber');
                    var couponprice;
                    var total = 0;
                    var countprice = data.price;
                    for (var i = 0; i < aLi.length; i++) {
                        shop(aLi[i]);
                    }
                    function shop(obj, num, price) {
                        console.log(data);
                        var aInp = obj.getElementsByTagName('input');
                        var aSpan = obj.getElementsByTagName('span');
                        var num = parseInt(aSpan[0].innerHTML);
                        var price = data.price;
                        aInp[0].onclick = function () {
                            if (num <= 0)return;
                            num--;
                            aSpan[0].innerHTML = num;
                            total--;
                            countprice -= price;
                            oldprice.innerHTML = countprice;
                            allprice.innerHTML = countprice;
                            setmax()
                        };
                        aInp[1].onclick = function () {
                            if (num >= remaining)return;
                            num++;
                            aSpan[0].innerHTML = num;
                            total++;
                            countprice += price;
                            oldprice.innerHTML = countprice;
                            allprice.innerHTML = countprice;
                            setmax()
                        };

                    }

                    function setmax() {
                        //allprice = 0;
                        var price = data.price;
                        if (coupontype == "1") {
                            couponprice = countprice - price;
                            allprice.innerHTML = couponprice;
                            (couponprice < 0 ) ? (allprice = 0) : (allprice = couponprice);
                        } else if (coupontype == "2" && price <= 300) {
                            couponprice = countprice - price;
                            allprice.innerHTML = couponprice;
                            (couponprice < 0 ) ? (allprice = 0) : (allprice = couponprice);
                        } else {
                            allprice.innerHTML = countprice;
                            allprice = countprice;
                        }
                        document.getElementById('allprice').innerHTML = allprice;

                        //alert(allprice);
                    }

                    //app交互——直接购买
                    $("#purchase").on("click", function () {
//             alert(
//                 "id:"+data.id+ '|' +
//                 "num:"+$('.numbox .num').text()+ '|' +
//                 "type:"+1+ '|' +
//                 "coupontype:"+coupontype.toString()+ '|' +
//                 "voucher:"+couponumber.toString()+ '|' +
//                 "remark:"+$('#remarks').val()+ '|' +
//                 "picturepath:"+data.picture.path+ '|' +
//                 "name:"+data.curriculumName+ '|' +
//                 "oldPrice:"+$('#oldprice').text()+ '|' +
//                 "newPrice:"+$('#allprice').text()+ '|' +
//                 "starttime:"+data.startDate+ '|' +
//                 "address1:"+data.store.storeName+ '|' +
//                 "address2:"+data.store.cityName + ' ' + data.store.areaName + ' ' + data.store.detailAddress
//
//             );
                        ft.purchase({
                            id: data.id,
                            price: data.price,
                            num: $('.numbox .num').text(),
                            type: 1,
                            coupontype:coupontype.toString(),
                            voucher: couponumber.toString(),
                            remark: $('#remarks').val(),
                            picturepath: data.picture.path,
                            name: data.curriculumName,
                            oldprice: $('#oldprice').text(),
                            newprice: $('#allprice').text(),
                            starttime: data.startDate,
                            address1: data.store.storeName,
                            address2: data.store.cityName + ' ' + data.store.areaName + ' ' + data.store.detailAddress,
                        }, function (result) {
                        })
                    });

                    $api.imgAdapt($buyedit.find('.titlepic'), data.picture.path);
                    $buyedit.find('.titletxt').text(data.curriculumName);
                    $buyedit.find('.editlist .time').text(datatime2(starttime) + hourtime(starttime, endtime));
                    $buyedit.find('.editlist .name').text(data.store.storeName);
                    $buyedit.find('.editlist .place').text(data.store.detailAddress);
                    $buyedit.find('.editlist .lightgrey b').text(remaining);
                    $buyedit.find('.ttprice span b').text(data.price);
                    $buyedit.find('.ttprice s b').text(data.price);
                    var remark = $('#remarks').val();

                    switch (data.status) {
                        case 'NEW': // 起售

                        case 'PRE': // 预售
                            $('.buy b').text(parseInt(data.price).toFixed(2));
                            $('.dis').hide();
                            break;
                        case 'EXD': // 已失效
                            $('.able').hide();
                            $('.dis').text('已开课');
                            $('.buy-box').css('background', '#676a6c');
                            $('.buy').css('box-shadow', '0px 2px 4px rgba(130,130,130,0.5)');
                            break;
                        case 'DON': //已售罄
                            $('.able').hide();
                            $('.dis').text('已售罄');
                            $('.buy-box').css('background', '#676a6c');
                            $('.buy').css('box-shadow', '0px 2px 4px rgba(130,130,130,0.5)');
                            break;
                        case 'DBL': // 不可用
                            $('.able').hide();
                            $('.dis').text('已失效');
                            $('.buy-box').css('background', '#676a6c');
                            $('.buy').css('box-shadow', '0px 2px 4px rgba(130,130,130,0.5)');
                            break;
                        default:
                            console.log('no');

                    }


                    data.cooks.forEach(function (item, index) {
                        var cooker = $('<section class="author teacher">\
                <div class="clearfix">\
                  <p class="author__info">\
                    <img src="' + item.picture.path + '">\
                    <span>\
                      <b>' + item.cookName + '</b>\
                      <strong class="text-overflow say">' + item.remark + '</strong>\
                    </span></p>\
                  <!-- <button class="red-btn add-care" data-follow="' + item.isFollow + '" data-id="' + item.id + '">' + (item.isFollow ? "已关注" : "加关注") + '</button> -->\
                </div>\
              </section>');
                        $('.teacher-box').append(cooker);
                    });

                    data.menuList.forEach(function (item, index) {
                        var img = $('<figure>\
              <img src="' + item.picture.path + '">\
              <figcaption>' + item.remark + '</figcaption>\
            </figure>');
                        $('.site-pic').append(img);
                    });

                });

        $('.course-info').on('click', '.add-care', function (e) {
            var id = $(e.target).data('id'),
                    follow = $(e.target).data('follow');
            if (follow) {
                $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/follow/cookCancel', {
                    "refId": id,
                    "type": 2,
                    "userId": 85507
                }, function (data) {
                    $(e.target).data('follow', false).text('加关注');
                });
            } else {
                $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/follow/cook', {
                    "refId": id,
                    "type": 2,
                    "userId": 85507
                }, function (data) {
                    $(e.target).data('follow', true).text('已关注');
                });
            }
        });

        $('.able').on('click', function (e) {
            var id = $(e.target).data('id');
            $api.post('http://121.40.135.115:8080/fotile-api-0.0.2/shoppingCart/create', {
                "count": 2,
                "refId": 662,
                "type": 1,
                "userId": 41
            });
        });

        $('.buynow').on('click', function () {
            $('.numbox .num').text("1");
            $('#remarks').val("");
            disableScroll = true;//禁止滚动
            $("html,body").css({overflow:"hidden"}); //禁用滚动条
            $('.dark-bg').show();
            $('.buynow-div').show();
        });
        $('#close-div').on('click', function () {
            disableScroll = false;//允许滚动
            $("html,body").css({overflow:"auto"}); //启用滚动条
            $('.dark-bg').hide();
            $('.buynow-div').hide();
            //location.reload()
        });

        $.loadComment({"pageNum": 1, "pageSize": 20, "type": 2, "refId": parseInt(id), "userId": parseInt(userid)}, 1);

    });
</script>
</body>

</html>
