<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- 这是个iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览；-->
    <meta content="yes" name="apple-mobile-web-app-capable">
    <!-- 全屏显示-->
    <meta name="apple-touch-fullscreen" content="yes">
    <!-- 不要让设备识别电话号码和邮箱地址-->
    <meta content="telephone=no,email=no" name="format-detection">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport"
          name="viewport">
    <!-- DNS预解析-->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <!--<link href="../css/common/reset.css" rel="stylesheet">-->
    <link href="../css/common.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/jf-info.css" rel="stylesheet">
    <link href="../css/download.css" rel="stylesheet">
    <title>积分换购</title>
</head>
<body>
<div id="buybox">
    <div class="jf-buy">
        <div class="swiper">
            <div class="focus">
                <mt-swipe :auto="4000">
                    <mt-swipe-item v-for="item in url">
                        <img :src="item.picture.path" alt="">
                    </mt-swipe-item>

                </mt-swipe>
            </div>
        </div>
        <div class="title">
            <h4>{{title}}</h4>
            <p>
                <span v-cloak><i class="icon-msg"></i> {{commentCount}}</span>
                <span v-cloak><i class="icon-broswer"></i> {{viewCount}}</span>
            </p>
        </div>
        <div class="sku">
            <ul>
                <li class="h_box">
                    <span class="tit">商品分类</span>
                    <p><span class="sku-sel" v-for="item in dataAll.merchandiseClasses"
                             :class="merchandiseClasses == item.id?'cur':''"
                             @click="selectType(item.id,item.stock,item.paidIntegral,item.integral,item,count,totalntegral)">{{item.argName}}</span>
                    </p>
                </li>
                <li class="h_box mt25">
                    <span class="tit">选择数量</span>
                    <em>(剩余{{stock}}张)</em>
                    <p class="textalign" >
                        <span class="icon-reduce" @click="changeNum(0)"></span>
                        <input v-model="count" value="" class="inputText" readonly type="text">
                        <span class="icon-add" @click="changeNum(1)"></span>
                    </p>
                </li>
            </ul>

        </div>

        <div class="details">
            <h3>商品详情</h3>
            <div class="msg">{{content}}</div>
        </div>

        <div class="details">
            <h3>物流说明</h3>
            <div class="msg">{{logistics}}</div>
        </div>

        <div class="details">
            <h3>售后服务</h3>
            <div class="msg">{{salesSupport}}</div>
        </div>

        <!--<div class="details">-->
            <!--<h3>联系客服</h3>-->
            <!--<div class="msg"><i class="icon-qq mr10"></i>客服方方 753113213</div>-->
        <!--</div>-->

    </div>

    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>

    <div class="btnbox">
        <ul class="h_box">
            <li>
                {{totalntegral}}<em>积分</em>
                <!--<span class="price" >{{payintegral}}积分</span>-->
                <span v-if="integral > payintegral">{{integral}}积分</span>
            </li>
            <li class="buy" @click="submit(dataAll.id,dataAll.paidIntegral)">兑换</li>
        </ul>
    </div>

</div>


<script>
</script>
<script src="../js/vue.min.js"></script>
<script src="../js/vue-resource1.3.4.js"></script>
<script src="https://unpkg.com/mint-ui/lib/index.js"></script>
<link rel="stylesheet" href="https://unpkg.com/mint-ui/lib/style.css">
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>

<script>

    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)return unescape(r[2]);
        return null;
    }

    var id = GetQueryString("id");
    var id=521;
    var vm = new Vue({
        el: '#buybox',
        data: {
            title: '',
            salesSupport: '',
            logistics: '',
            content: '商品详情',
            viewCount: '',
            commentCount: '',
            dataAll: [],
            payintegral: '',
            integral: '',
            count: 0,
            receiptAddress: '',
            userId: '',
            stock: '',
            merchandiseClasses: '',
            url: [],
            totalntegral: ''

        },
        component: {},
        created: function () {
            var $this = this;
            this.$http.post('http://121.40.135.115:8080/fotile-api-0.0.2/merchandise/detail', {"id": id}).then(function (data) {
                var data = data.data;
                console.log(data);
                if (data.status == 200) {
                    $this.logistics = data.data.logisticsDesc;
                    $this.salesSupport = data.data.salesSupport;
                    $this.content = data.data.content;
                    $this.title = data.data.title;
                    $this.viewCount = data.data.viewCount;
                    $this.commentCount = data.data.commentCount;
                    $this.dataAll = data.data;
                    $this.stock = data.data.stock;
                    $this.merchandiseClasses = data.data.selectMerchandiseClass;
                    $this.url = data.data.merchandisePictures;
                }

            }, function () {
                console.info('error');
            });

        },
        methods: {

            submit: function (id, b) {
                var $this = this;
                //app交互——获取登录状态
                ft.isLogin(function (result) {
                    var errorcode = result.errorCode.toString();
                    if (errorcode == "1") {
                        //$api.toast('登陆成功', 2000);
                        userid = result.data.userId.toString();
                        window.userid=userid;
                        alert("userid"+userid);
                        //积分兑换
                        if($this.count==0){
                            alert("请先选择商品!");
                            return;
                        }
                        var flag = confirm("确认兑换该商品吗？");
                        if(!flag)return;
                        $this.userId =userid;
                        $this.getAddress(this.userId);

                    } else if (errorCode == "0") {
                        $api.toast('登陆取消', 2000);
                    } else if (errorCode == "-1") {
                        $api.toast('登陆失败', 2000);
                    } else if (errorCode == "-2") {
                        $api.toast('登陆不支持', 2000);
                    }
                });
                  //积分兑换
//                if($this.count==0){
//                    alert("请先选择商品!");
//                    return;
//                }
//                window.userid=120374;
//                var flag = confirm("确认兑换该商品吗？");
//                if(!flag)return;
//                var $this = this;
//                this.userId =userid;
//                this.getAddress(this.userId);
            },
            getAddress: function (userId, back) {
                var $this = this;
                this.$http.post('http://121.40.135.115:8080/fotile-api-0.0.2/receiptAddress/default', {"userId": this.userId}).then(function (data) {
                    console.log(data.data.data);
                    if(data.data.data==null){
                        alert("请先编辑收货地址！");
                        return;
                    }
                    $this.receiptAddress = data.data.data.id;
                    console.info($this.receiptAddress);
                    $this.submitFn($this.receiptAddress);
                }, function (err) {

                });
            },
            submitFn: function (address) {
                var $this = this;
                this.$http.post('http://121.40.135.115:8080/fotile-api-0.0.2/order/createByIntegral', {
                    'userId': $this.userId,
                    'receiptAddressId': address,
                    'productId': $this.dataAll.id,
                    'count': $this.count,
                    'classId': $this.merchandiseClasses

                }).then(function (data) {
                    console.info(data.status);
                    if (data.status == 200) {
                        alert('兑换成功');
                    }
                }, function (err) {

                });
            },
            selectType: function (classid, stock, paidIntegral, integral, item,count,totalntegral) {
                var $this = this;
                //console.info(item);
                $this.merchandiseClasses = classid;
                $this.stock = stock;
                $this.payintegral = paidIntegral;
                paidintegral=$this.payintegral;
                $this.integral = integral;
                $this.url.length = 0;
                $this.url.push(item);
                $this.count=1;
                if (stock>0){
                    $this.count=1;
                    $this.totalntegral=paidIntegral;
                }else {
                    $this.count=0;
                    $this.totalntegral=0;
                }

            },
            changeNum: function (type,totalntegral) {
                if (type == 0) {
                    this.count = this.count - 1 > 1 ? this.count - 1 : 1;
                    this.totalntegral = paidintegral * this.count;
                } else {
                    this.count = this.count + 1 > this.stock ? this.stock : this.count + 1;
                    this.totalntegral = paidintegral * this.count;
                }
            }

        }
    });

    $.loadComment({"pageNum":1,"pageSize":5,"refId":parseInt(id),"type":10}, 1);

</script>


</body>
</html>