<!DOCTYPE html>
<html>

<head>
    <title>活动内页</title>
    <meta charset="utf-8">
    <meta name='viewport'
          content='width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,minimum-scale=1.0'>
    <link rel="stylesheet" type="text/css" href="../css/common.css">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <link rel="stylesheet" type="text/css" href="../css/lifedetail.css">
    <style type="text/css">
        .header__main .title {
            background: transparent;
        }

        .header__main .title time {
            position: static;
        }
    </style>
    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function(){
            _vds.push(['setAccountId', '80624a28abff7348']);
            (function() {
                var vds = document.createElement('script');
                vds.type='text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
</head>

<body>
<div>
    <header class="header">
        <div class="header__main">
            <div class="img"></div>
            <div class="">
            </div>
            <div class="title">
                <p class="txt">

                </p>
                <time></time>
            </div>
        </div>
        <div class="header__opt">
            <span class="view-count"><strong></strong></span>
            <span class="comment-count" id="star"><strong></strong></span>
        </div>
    </header>
    <article class="content">
    </article>
    <div class="active-rule">
        <h3 class="section-title">活动规则</h3>
        <ul>

        </ul>
    </div>
    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>

</div>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src='../js/judge.js'></script>
<!--<script src="../js/alertdiy.js"></script>-->
<script src="../js/url.js"></script>
<script type="text/javascript">
    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)return unescape(r[2]);
        return null;
    }

    var id = GetQueryString("id");

    var device = GetQueryString("device");
    if (device == "ios" || device == "android") {
        var userid;
        //app交互—获取userid
        window.onload = function () {
            ft.isLogin2(function (result) {
                var errorcode = result.errorCode.toString();
                //alert(errorcode);
                console.log(errorcode);
                if (errorcode == "1") {
                    userid = result.data.userId.toString();

                    choose();

                } else if (errorCode == "0") {
                } else if (errorCode == "-1") {
                } else if (errorCode == "-2") {
                }
            });
        };
    } else if ((device == null)) {
        var userid = 1;
        choose();
    }
    function choose() {
        $api.post(urlport + 'activity/detail', {
            id: id
        }, function (res) {
            data = res.data;
            console.log(res);
            var $header = $('.header');
            var $content = $('.content');
            $api.imgAdapt($header.find('.header__main .img'), data.picture.path);
            $header.find('.header__main .txt').text(data.title);
            $header.find('.view-count strong').text(data.viewCount);
            $header.find('.favorite-count strong').text(data.likeCount);
            $header.find('.comment-count strong').text(data.commentCount);
            $('.active-rule ul').html(data.rule);

            /*title取值*/
            var txt = data.title;
            if (txt == undefined) {
                $('head title').text("活动详情");
            } else {
                $('head title').text(data.title);
            }
            /* 时间戳格式转换 */
            var starttime = data.startDate;
            var endtime = data.endDate;

            function add0(m) {
                return m < 10 ? '0' + m : m
            }

            function format(starttime) {
                var time = new Date(starttime);
                var year = time.getFullYear();
                var month = time.getMonth() + 1;
                var date = time.getDate();
                var hour = time.getHours();
                var minute = time.getMinutes();
                return year + '年' + add0(month) + '月' + add0(date) + '号' + add0(hour) + ':' + add0(minute);
            }

            function format(endtime) {
                var time = new Date(endtime);
                var year = time.getFullYear();
                var month = time.getMonth() + 1;
                var date = time.getDate();
                var hour = time.getHours();
                var minute = time.getMinutes();
                return year + '年' + add0(month) + '月' + add0(date) + '号' + add0(hour) + ':' + add0(minute);
            }

            if(data.isshow==1 || data.isshow==null){
                $header.find('time').text(format(starttime) + '-' + format(endtime));
            }else {
                $header.find('time').text();
            }

            $content.append(data.content);

            /*微信分享链接专用*/
            var sharetitle = data.title;
            var sharedesc=data.desc;
            var shareimg = data.picture.path;
            var sharestr = data.url;
            var sharelink = sharestr.replace(/api/, "h5");
            console.log(sharetitle + "|" + shareimg + "|" + sharelink + "|" + sharedesc);
            $.ajax({
                type: 'GET',
                url: urlport + 'wx/wxConfig.json?url=' + encodeURIComponent(window.location.href.split('#')[0]),
                success: function (data) {
                    console.info(data.appId);
                    wx.config({
                        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        appId: data.appId, // 必填，公众号的唯一标识
                        timestamp: data.timestamp, // 必填，生成签名的时间戳
                        nonceStr: data.nonceStr, // 必填，生成签名的随机串
                        signature: data.signature,
                        jsApiList: [
                            "onMenuShareTimeline",
                            "onMenuShareAppMessage",
                            "onMenuShareQQ",
                            "onMenuShareWeibo",
                            "onMenuShareQZone"
                        ]
                    });
                    wx.ready(function () {
                        //分享给朋友圈
                        wx.onMenuShareTimeline({
                            title: sharetitle, // 分享标题
                            link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                            imgUrl: shareimg, // 分享图标
                            success: function () {
                                // 用户确认分享后执行的回调函数
                            },
                            cancel: function () {
                                // 用户取消分享后执行的回调函数
                            }
                        });
                        //分享给朋友
                        wx.onMenuShareAppMessage({
                            title: sharetitle, // 分享标题
                            desc: contents, // 分享描述
                            link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                            imgUrl: shareimg, // 分享图标
                            type: '', // 分享类型,music、video或link，不填默认为link
                            dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                            success: function () {
                                // 用户确认分享后执行的回调函数
                            },
                            cancel: function () {
                                // 用户取消分享后执行的回调函数
                            }
                        });
                    });
                },
                error: function (xhr, type) {
                    //alert(111);
                }
            })
        });

        $.loadComment({
            "pageNum": 1,
            "pageSize": 30,
            "type": 6,
            "refId": parseInt(id),
            "userId": parseInt(userid)
        }, 1);
    }


</script>
</body>
</html>
