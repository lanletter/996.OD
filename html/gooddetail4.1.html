<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name='viewport'
          content='width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,minimum-scale=1.0,telephone=yes'>
    <link href="../css/common.css?ver=403" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css?ver=403">
    <link href="../css/animate.css?ver=403" rel="stylesheet">
    <link href="../css/jf-info.css?ver=403" rel="stylesheet">
    <link href="../css/gooddetail.css?ver=403" rel="stylesheet">
    <link rel="stylesheet" href="../css/mint-ui.css?ver=403">
    <link type="text/css" rel="stylesheet" href="../css/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="../css/shCoreDefault.css"/>
    <title>商品内页4.1</title>
    <style>
        .icon-truck {
            display: inline-block;
            width: 0.56rem;
            height: 0.56rem;
            background: url(../img/truck2x.png) no-repeat center center;
            background-size: cover;
            vertical-align: middle;
            margin-right: 0.2rem;
        }

        .icon-fix {
            display: inline-block;
            width: 0.56rem;
            height: 0.56rem;
            background: url(../img/fix2x.png) no-repeat center center;
            background-size: cover;
            vertical-align: middle;
            margin-right: 0.2rem;
        }
    </style>
    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function () {
            _vds.push(['setAccountId', '80624a28abff7348']);
            (function () {
                var vds = document.createElement('script');
                vds.type = 'text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
</head>
<body>
<div id="buybox">
    <div class="jf-buy">
        <div class="swiper">
            <div class="focus">
                <mt-swipe :auto="4000">
                    <mt-swipe-item v-for="item in url">
                        <img :src="item.imgUrl" alt="">
                    </mt-swipe-item>
                </mt-swipe>
            </div>
        </div>
        <div class="title">
            <h4 v-html="title"></h4>
            <p>
                <span><i class="icon-broswer"></i><b v-html="viewCount"></b></span>
                <span><i class="icon-msg"></i><b v-html="commentCount"></b></span>
            </p>
        </div>

        <div id="locationaddress" class="addressbox">
            <img src="../img/right.png" class="arwright"/>
            <p class="adtitle">配送至：</p>
            <span class="locationaddress">上海市徐汇区</span>
            <span class="provinceName" style="display: none;">上海市</span>
            <span class="cityName" style="display: none;">上海市</span>
            <span class="areaName" style="display: none;">徐汇区</span>
            <span>，请选择规格</span>
        </div>
        <div class="bottomdiv"></div>

        <div class="dark-bg"></div>
        <div id="popupbox">
            <div class="m-lr">
                <img src="../img/class.png" id="close-div"/>
                <div class="popup-close"></div>
                <div class="imgtitle" v-bind:style="{backgroundImage: 'url(' +imgtitle+ ')'}"></div>
                <div class="pricebox">
                    <p class="textitle" v-html="title"></p>
                    <p class="price"><span>￥</span><span id="price">0</span></p>
                    <em class="counts">(库存<span id="counts">0</span>件)</em>
                    <em class="counts">(uuid=<span id="uuid">--</span>)</em>
                </div>
                <div id="chooseaddress1" class="addressbox">
                    <img src="../img/right.png" class="arwright"/>
                    <p class="adtitle">配送至：</p>
                    <span class="locationaddress">上海市徐汇区</span>
                    <span class="provinceName" style="display: none;"></span>
                    <span class="cityName" style="display: none;"></span>
                    <span class="areaName" style="display: none;"></span>
                </div>

                <div class="selectsku">
                    <!--<div v-for="(item,index) in keyValueMap">-->
                    <!--<p class="adtitle" v-html="index">颜色分类：</p>-->
                    <!--<input v-for="ite in keyValueMap[index]" type="button" class="sku"-->
                    <!--@click="selectSku(item.id,item.stock,item.paidIntegral,item,count)"-->
                    <!--v-bind:attr_id="ite" v-bind:value="ite"/>-->
                    <!--</div>-->
                </div>
                <div class="brtop">
                    <p class="adtitle">选择数量</p>
                    <div class="textalign">
                        <span class="icon-reduce" @click="changeNum(0)"></span>
                        <input v-model="count" value="" class="inputText" readonly type="text">
                        <span class="icon-add" @click="changeNum(1)"></span>
                    </div>
                </div>
            </div>
            <div class="goodbtn">
                <span id="addtocart1" class="addtocart">加入购物车</span>
                <span id="justbuy1" class="justbuy">立即购买</span>
                <span id="ensureCart" class="ensure">确定</span>
                <span id="ensureBuy" class="ensure">确定</span>
            </div>
        </div>

        <!--<div class="skus">-->
        <!--<ul>-->
        <!--<li class="h_box">-->
        <!--<span class="tit">商品分类</span>-->
        <!--<p><span class="sku-sel" v-for="item in dataAll.merchandiseClasses"-->
        <!--:class="merchandiseClasses == item.id?'cur':''"-->
        <!--@click="selectType(item.id,item.stock,item.paidIntegral,item.integral,item,count,totalntegral)"-->
        <!--v-html="item.argName"></span>-->
        <!--</p>-->
        <!--</li>-->
        <!--<li class="h_box mt15" style="height: 0.54rem;">-->
        <!--<span class="tit">选择数量</span>-->
        <!--<em>(剩余<span v-html="stock"></span>)</em>-->
        <!--<p class="textalign">-->
        <!--<span class="icon-reduce" @click="changeNum(0)"></span>-->
        <!--<input v-model="count" value="" class="inputText" readonly type="text">-->
        <!--<span class="icon-add" @click="changeNum(1)"></span>-->
        <!--</p>-->
        <!--</li>-->
        <!--</ul>-->
        <!--</div>-->

        <!--<div class="selectsku">-->
        <!--<div>-->
        <!--<p class="adtitle">颜色分类：</p>-->
        <!--<input type="button" class="sku" attr_id="24" value="24"/>-->
        <!--<input type="button" class="sku" attr_id="25" value="25"/>-->
        <!--</div>-->
        <!--<div>-->
        <!--<p class="adtitle">尺寸大小：</p>-->
        <!--<input type="button" class="sku" attr_id="12" value="12"/>-->
        <!--<input type="button" class="sku" attr_id="13" value="13"/>-->
        <!--</div>-->
        <!--<div>-->
        <!--<p class="adtitle">选择样式：</p>-->
        <!--<input type="button" class="sku" attr_id="31" value="31"/>-->
        <!--<input type="button" class="sku" attr_id="32" value="32"/>-->
        <!--</div>-->
        <!--<div class="brtop">-->
        <!--<p class="adtitle">选择数量</p>-->
        <!--<div class="textalign">-->
        <!--<span class="icon-reduce" @click="changeNum(0)"></span>-->
        <!--<input v-model="count" value="" class="inputText" readonly type="text">-->
        <!--<span class="icon-add" @click="changeNum(1)"></span>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <div class="details">
            <h3>商品详情</h3>
            <div class="msg" v-html="content"></div>
        </div>

        <div class="details">
            <h3><i class="icon-truck"></i>物流说明</h3>
            <div class="msg" v-html="logistics"></div>
        </div>

        <div class="details">
            <h3><i class="icon-fix"></i>售后保障</h3>
            <div class="msg" v-html="salesSupport"></div>
        </div>

        <!--<div class="details">-->
        <!--<h3>联系客服</h3>-->
        <!--<div class="msg"><i class="icon-qq mr10"></i>客服方方 753113213</div>-->
        <!--</div>-->
    </div>

    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>
    <!--<div id="loading"></div>-->
    <br/><br/>

    <div class="goodbtn">
        <span id="addtocart2" class="addtocart">加入购物车</span>
        <span id="justbuy2" class="justbuy">立即购买</span>
    </div>
    <!--<div class="btnbox">-->
    <!--<ul class="h_box">-->
    <!--<li>-->
    <!--<div style="display: inline;" v-html="totalntegral"></div>-->
    <!--<em>积分</em>-->
    <!--&lt;!&ndash;<span class="price" >{{payintegral}}积分</span>&ndash;&gt;-->
    <!--<span v-if="integral > payintegral" v-html="integral">积分</span>-->
    <!--</li>-->
    <!--<li class="buy" @click="submit(dataAll.id,dataAll.paidIntegral)">兑换</li>-->
    <!--</ul>-->
    <!--</div>-->
</div>

<script>
</script>
<script src="../js/vue.min.js"></script>
<script src="../js/vue-resource1.3.4.js"></script>
<script src="../js/mint-ui.js"></script>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script src="../js/url.js"></script>
<script type="text/javascript" src='../js/jquery.cookie.js'></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src="../js/json2.js"></script>
<script type="text/javascript" src="../js/shCore.js"></script>
<script type="text/javascript" src="../js/shBrushJScript.js"></script>
<script>

    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }

    var id = GetQueryString("uuid").toString();

    var device = GetQueryString("device");
    if (device == "ios" || device == "android") {
        var userid;
        //app交互—获取userid
        window.onload = function () {
            ft.isLogin2(function (result) {
                var errorcode = result.errorCode.toString();
                //alert(errorcode);
                console.log(errorcode);
                if (errorcode == "1") {
                    userid = result.data.userId.toString();
                    choose();
                } else if (errorCode == "0") {
                } else if (errorCode == "-1") {
                } else if (errorCode == "-2") {
                }
            });
        };
    } else if ((device == null)) {
        var userid = 1;
        choose();
    }

    function choose() {
        var vm = new Vue({
            el: '#buybox',
            data: {
                title: '',
                shopname: '',
                salesSupport: '',
                logistics: '',
                content: '商品详情',
                viewCount: '',
                commentCount: '',
                dataAll: [],
                payintegral: '',
                integral: '',
                count: 1,
                receiptAddress: '',
                userId: '',
                stock: '',
                merchandiseClasses: '',
                url: [],
                totalntegral: '',
                imgtitle: '',
                skuInfoList: '',
                keyValueMap: '',
                description: '',
                image: '',
                inventory: '',
                name: '',
                price: '',
                productUuid: '',
                uuid: '',
                shop:[]
            },
            component: {},
            created: function () {
                var $this = this;
                this.$http.post(urlport + 'product/detail/v410', {"uuid": id}).then(function (data) {
                    var data = data.data;
                    console.log(data);
//                    alert(JSON.stringify(data));
                    if (data.status == 200) {
                        $this.logistics = data.data.logisticsDesc;
                        $this.salesSupport = data.data.salesSupport;
                        $this.content = data.data.content;
                        $this.title = data.data.name;
                        $this.shop = data.data.shop;
                        $this.viewCount = data.data.viewCount;
                        $this.commentCount = data.data.commentCount;
                        $this.dataAll = data.data;
                        $this.merchandiseClasses = data.data.selectMerchandiseClass;
                        $this.url = data.data.productImgList;
                        $this.stock = 0;//初始库存
                        $this.imgtitle = data.data.productImgList[0].imgUrl;
                        $this.skuInfoMap = data.data.skuInfoMap;
                        $this.keyValueMap = data.data.keyValueMap;
                        console.log($this.keyValueMap);
                        console.log($this.skuInfoMap);

                        for (var key in $this.keyValueMap) {
                            var skudiv = $('<div>\
                                <p class="adtitle">' + key + '</p>\
                            </div>');
                            $('.selectsku').append(skudiv);

                            var value = $this.keyValueMap[key];
//                            console.log(value);
                        }
                        var j = 0;
                        for (var key in $this.keyValueMap) {
                            var value = $this.keyValueMap[key];
//                            console.log(value);
                            for (var i = 0; i < value.length; i++) {
                                var skuinput = $('\
                                <input type="button" class="sku" attr_id="' + value[i] + '" value="' + value[i] + '"/>\
                                 ');
                                $(".selectsku div:eq(" + j + ")").append(skuinput);
//                                console.log(value[i]);
                            }
                            j++;
                        }

                        /* ----------------sku选择开始---------------- */
                        var startTime = new Date().getTime();
//                        var keys = [['24', '25'], ['12', '13'], ['31', '32']];
//                        var valuedata = {
//                            "24;12;31": {price: 366.00, inventory: 46},
//                            "25;12;32": {price: 406, inventory: 66},
//                            "24;13;32": {price: 466, inventory: 56},
//                            "24;12;31": {price: 406, inventory: 66}
//                        };
//                         var valuedata = {
//                             "红色;1Kg": { uuid: 1,price: 1000, inventory: 10},
//                             "红色;2Kg": { uuid: 2,price: 1000, inventory: 30},
//                             "蓝色;1Kg": { uuid: 3,price: 800, inventory: 5},
//                             "蓝色;2Kg": { uuid: 4,price: 800, inventory: 20}
//                         };
                        var valuedata = $this.skuInfoMap;
                        // console.log(valuedata);

                        //保存最后的组合结果信息
                        var SKUResult = {};

                        //获得对象的key
                        function getObjKeys(obj) {
                            if (obj !== Object(obj)) throw new TypeError('Invalid object');
                            var keys = [];
                            for (var key in obj)
                                if (Object.prototype.hasOwnProperty.call(obj, key))
                                    keys[keys.length] = key;
                            return keys;
                        }

                        //把组合的key放入结果集SKUResult
                        function add2SKUResult(combArrItem, sku) {
                            var key = combArrItem.join(";");
                            if (SKUResult[key]) {//SKU信息key属性·
                                SKUResult[key].inventory += sku.inventory;
                                SKUResult[key].prices.push(sku.price);
                                SKUResult[key].uuid = sku.uuid;
                            } else {
                                SKUResult[key] = {
                                    inventory: sku.inventory,
                                    prices: [sku.price],
                                    uuid: sku.uuid
                                };
                            }
                        }

                        //初始化得到结果集
                        function initSKU() {
                            var i, j, skuKeys = getObjKeys(valuedata);
                            for (i = 0; i < skuKeys.length; i++) {
                                var skuKey = skuKeys[i];//一条SKU信息key
                                var sku = valuedata[skuKey];	//一条SKU信息value
                                var skuKeyAttrs = skuKey.split(";"); //SKU信息key属性值数组
                                skuKeyAttrs.sort(function (value1, value2) {
                                    return parseInt(value1) - parseInt(value2);
                                });

                                //对每个SKU信息key属性值进行拆分组合
                                var combArr = combInArray(skuKeyAttrs);
                                for (j = 0; j < combArr.length; j++) {
                                    add2SKUResult(combArr[j], sku);
                                }

                                //结果集接放入SKUResult
                                SKUResult[skuKeyAttrs.join(";")] = {
                                    inventory: sku.inventory,
                                    prices: [sku.price],
                                    uuid: sku.uuid
                                }
                            }
                        }

                        /**
                         * 从数组中生成指定长度的组合
                         * 方法: 先生成[0,1...]形式的数组, 然后根据0,1从原数组取元素，得到组合数组
                         */
                        function combInArray(aData) {
                            if (!aData || !aData.length) {
                                return [];
                            }

                            var len = aData.length;
                            var aResult = [];

                            for (var n = 1; n < len; n++) {
                                var aaFlags = getCombFlags(len, n);
                                while (aaFlags.length) {
                                    var aFlag = aaFlags.shift();
                                    var aComb = [];
                                    for (var i = 0; i < len; i++) {
                                        aFlag[i] && aComb.push(aData[i]);
                                    }
                                    aResult.push(aComb);
                                }
                            }

                            return aResult;
                        }

                        /**
                         * 得到从 m 元素中取 n 元素的所有组合
                         * 结果为[0,1...]形式的数组, 1表示选中，0表示不选
                         */
                        function getCombFlags(m, n) {
                            if (!n || n < 1) {
                                return [];
                            }

                            var aResult = [];
                            var aFlag = [];
                            var bNext = true;
                            var i, j, iCnt1;

                            for (i = 0; i < m; i++) {
                                aFlag[i] = i < n ? 1 : 0;
                            }

                            aResult.push(aFlag.concat());

                            while (bNext) {
                                iCnt1 = 0;
                                for (i = 0; i < m - 1; i++) {
                                    if (aFlag[i] == 1 && aFlag[i + 1] == 0) {
                                        for (j = 0; j < i; j++) {
                                            aFlag[j] = j < iCnt1 ? 1 : 0;
                                        }
                                        aFlag[i] = 0;
                                        aFlag[i + 1] = 1;
                                        var aTmp = aFlag.concat();
                                        aResult.push(aTmp);
                                        if (aTmp.slice(-n).join("").indexOf('0') == -1) {
                                            bNext = false;
                                        }
                                        break;
                                    }
                                    aFlag[i] == 1 && iCnt1++;
                                }
                            }
                            return aResult;
                        }

                        //初始化用户选择事件
                        $(function () {
                            initSKU();
                            var endTime = new Date().getTime();
                            $('#init_time').text('init sku time: ' + (endTime - startTime) + " ms");
                            $('.sku').each(function () {
                                var self = $(this);
                                var attr_id = self.attr('attr_id');
                                if (!SKUResult[attr_id]) {
                                    self.attr('disabled', 'disabled');
                                    $("[disabled=disabled]").addClass("bh-sku-disabled");
                                }
                            }).click(function () {
                                var self = $(this);

                                //选中自己，兄弟节点取消选中
                                self.toggleClass('bh-sku-selected').siblings().removeClass('bh-sku-selected');

                                //已经选择的节点
                                var selectedObjs = $('.bh-sku-selected');

                                if (selectedObjs.length) {
                                    //获得组合key价格
                                    var selectedIds = [];
                                    selectedObjs.each(function () {
                                        selectedIds.push($(this).attr('attr_id'));
                                    });
                                    selectedIds.sort(function (value1, value2) {
                                        return parseInt(value1) - parseInt(value2);
                                    });
                                    var len = selectedIds.length;
                                    var prices = SKUResult[selectedIds.join(';')].prices;
                                    var counts = SKUResult[selectedIds.join(';')].inventory;
                                    var uuid = SKUResult[selectedIds.join(';')].uuid;
                                    var maxPrice = Math.max.apply(Math, prices);
                                    var minPrice = Math.min.apply(Math, prices);
                                    $('#price').text(maxPrice > minPrice ? minPrice + "-" + maxPrice : maxPrice);
                                    $('#counts').text(counts);
                                    $('#uuid').text(uuid);
                                    $this.stock = $("#counts").text();
                                    $this.uuid = $("#uuid").text();
                                    if ($this.count > $this.stock) {//防止选择数量大于库存
                                        $this.count = $this.stock
                                    }

                                    //用已选中的节点验证待测试节点 underTestObjs
                                    $(".sku").not(selectedObjs).not(self).each(function () {
                                        var siblingsSelectedObj = $(this).siblings('.bh-sku-selected');
                                        var testAttrIds = [];//从选中节点中去掉选中的兄弟节点
                                        if (siblingsSelectedObj.length) {
                                            var siblingsSelectedObjId = siblingsSelectedObj.attr('attr_id');
                                            for (var i = 0; i < len; i++) {
                                                (selectedIds[i] != siblingsSelectedObjId) && testAttrIds.push(selectedIds[i]);
                                            }
                                        } else {
                                            testAttrIds = selectedIds.concat();
                                        }
                                        testAttrIds = testAttrIds.concat($(this).attr('attr_id'));
                                        testAttrIds.sort(function (value1, value2) {
                                            return parseInt(value1) - parseInt(value2);
                                        });
                                        if (!SKUResult[testAttrIds.join(';')]) {
                                            $(this).attr('disabled', 'disabled');
                                            $("[disabled=disabled]").removeClass('bh-sku-selected');
                                            $("[disabled=disabled]").addClass("bh-sku-disabled");
                                        } else {
                                            $(this).removeAttr('disabled');
                                            $(this).removeClass('bh-sku-disabled');
                                        }
                                    });
                                } else {
                                    //设置默认价格
                                    $('#price').text('0');
                                    $('#counts').text('1');
                                    $('#uuid').text('--');
                                    $this.stock = $("#counts").text();
                                    $this.uuid = $("#uuid").text();
                                    if ($this.count > $this.stock) {//防止选择数量大于库存
                                        $this.count = $this.stock
                                    }
                                    //设置属性状态
                                    $('.sku').each(function () {
                                        SKUResult[$(this).attr('attr_id')] ? $(this).removeAttr('disabled').removeClass('bh-sku-disabled') : $(this).attr('disabled', 'disabled').removeClass('bh-sku-selected');
                                    })
                                }
                            });
                        });
                        /* ----------------sku选择结束---------------- */

                        /*APP交互获取定位*/
                        if (userid == 1 || userid == null) {
                            ft.locationAddress(function (result) {
//                                alert(JSON.stringify(result));
                                var errorcode = result.errorCode.toString();
                                console.log(errorcode);
                                if (errorcode == "1") {
                                    var province = result.data.province;
                                    var city = result.data.city;
                                    var district = result.data.district;
                                    $(".locationaddress").text(province + city + district);
                                    $(".provinceName").text(province);
                                    $(".cityName").text(city);
                                    $(".areaName").text(district);
                                } else if (errorCode == "0") {
                                } else if (errorCode == "-1") {
                                } else {
                                    return
                                }
                            });
                        } else {
                            $.ajax({
                                url: urlport + 'receiptAddress/default',
                                type: 'POST',
                                data: JSON.stringify({"id": id, "userId": userid}),
                                timeout: 5000, //超时时间
                                contentType: "application/json;charset=utf-8",
                                dataType: 'json', //返回的数据格式：json/xml/html/script/jsonp/text
                                success: function (data, textStatus) {
//                                    alert(JSON.stringify(data));
                                    if (data.data !== null) {
                                        var province = data.data.provinceName;
                                        var city = data.data.cityName;
                                        var district = data.data.areaName;
                                        $(".locationaddress").text(province + city + district);
                                        $(".provinceName").text(province);
                                        $(".cityName").text(city);
                                        $(".areaName").text(district);
                                    } else {
                                        ft.locationAddress(function (result) {
//                                            alert(JSON.stringify(result));
                                            var errorcode = result.errorCode.toString();
                                            console.log(errorcode);
                                            if (errorcode == "1") {
                                                var province = result.data.province;
                                                var city = result.data.city;
                                                var district = result.data.district;
                                                $(".locationaddress").text(province + city + district);
                                                $(".provinceName").text(province);
                                                $(".cityName").text(city);
                                                $(".areaName").text(district);
                                            } else if (errorCode == "0") {
                                            } else if (errorCode == "-1") {
                                            } else {
                                                return
                                            }
                                        });
                                    }
                                },
                                error: function (xhr, textStatus) {
                                    console.log('错误');
                                    console.log(JSON.stringify(xhr));
                                    console.log(JSON.stringify(textStatus))
                                }
                            });
                        }
                        /*APP交互修改地址*/
                        $("#chooseaddress1").click(function () {
                            ft.chooseAddress(function (result) {
//                                alert(JSON.stringify(result));
                                var errorcode = result.errorCode.toString();
                                console.log(errorcode);
                                if (errorcode == "1") {
                                    var province = result.data.provinceName;
                                    var city = result.data.cityName;
                                    var district = result.data.areaName;
                                    $(".locationaddress").text(province + city + district);
                                    $(".provinceName").text(province);
                                    $(".cityName").text(city);
                                    $(".areaName").text(district);
                                } else if (errorCode == "0") {
                                    return
                                } else if (errorCode == "-1") {
                                    return
                                } else {
                                    return
                                }
                            });
                        });
                        /*APP交互加购物车&立即购买*/
                        $("#locationaddress").click(function () {
                            $('.dark-bg').show();
                            $("#popupbox").show();
                            $("#popupbox #addtocart1").show();
                            $("#popupbox #justbuy1").show();
                            $("#popupbox #ensureCart").hide();
                            $("#popupbox #ensureBuy").hide();
                        });
                        $("#addtocart2").click(function () {
                            $('.dark-bg').show();
                            $("#popupbox").show();
                            $("#popupbox #addtocart1").hide();
                            $("#popupbox #justbuy1").hide();
                            $("#popupbox #ensureCart").show();
                            $("#popupbox #ensureBuy").hide();
                        });
                        $("#justbuy2").click(function () {
                            $('.dark-bg').show();
                            $("#popupbox").show();
                            $("#popupbox #addtocart1").hide();
                            $("#popupbox #justbuy1").hide();
                            $("#popupbox #ensureCart").hide();
                            $("#popupbox #ensureBuy").show();
                        });
                        $("#close-div").click(function () {
                            $("#popupbox").hide();
                            $('.dark-bg').hide();
                        });
                        $("#addtocart1").click(function () {
                            ft.addCartGood({
                                skuUuid: $("#uuid").text(),
                                count: $(".inputText").val()
                            }, function (result) {

                            })
                        });
                        $("#ensureCart").click(function () {
                            $("#addtocart1").trigger('click');
                        });
                        $("#justbuy1").click(function () {
                            console.log({
                                shopUuid:$this.shop.uuid,
                                shopName: $this.shop.name,
                                productUuid:$this.dataAll.uuid,
                                skuUuid:$("#uuid").text(),
                                productCountNum: $(".inputText").val(),
                                productimage: $this.imgtitle,
                                productName: $this.title,
                                productPrice: $("#price").text(),
                                productInventory:$("#counts").text(),
                                skuName: $("#uuid").text(),
                                provinceName: $(".provinceName").text(),
                                cityName: $(".cityName").text(),
                                areaName: $(".areaName").text()
                            });
                            ft.purchaseGood({
                                shopUuid:$this.shop.uuid,
                                shopName: $this.shop.name,
                                productUuid:$this.dataAll.uuid,
                                skuUuid:$("#uuid").text(),
                                productCountNum: $(".inputText").val(),
                                productimage: $this.imgtitle,
                                productName: $this.title,
                                productPrice: $("#price").text(),
                                productInventory:$("#counts").text(),
                                skuName: $("#uuid").text(),
                                provinceName: $(".provinceName").text(),
                                cityName: $(".cityName").text(),
                                areaName: $(".areaName").text()
                            }, function (result) {

                            });
                        });
                        $("#ensureBuy").click(function () {
                            $("#justbuy1").trigger('click');
                        });

                        /*微信分享链接专用*/
                        var sharetitle = data.neme;
                        var sharedesc;
                        var contents = $(".msg").text().replace(/[\r\n]/g, "").replace(/(^\s+)|(\s+$)/g, "").replace(/\s/g, "");
                        var count = contents.length;
                        if (count > 40) {
                            var nr = contents.substring(0, 40) + "...";
                            sharedesc = nr;
                        } else {
                            sharedesc = contents;
                        }
                        var shareimg = $this.imgtitle;
                        var sharestr = window.location.href;
                        var sharelink = sharestr.replace(/api/, "h5");
                        console.log(sharetitle + "|" + shareimg + "|" + sharelink + "|" + sharedesc);
                        $.ajax({
                            type: 'GET',
                            url: urlport + 'wx/wxConfig.json?url=' + encodeURIComponent(window.location.href.split('#')[0]),
                            success: function (data) {
                                console.info(data.appId);
                                wx.config({
                                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                                    appId: data.appId, // 必填，公众号的唯一标识
                                    timestamp: data.timestamp, // 必填，生成签名的时间戳
                                    nonceStr: data.nonceStr, // 必填，生成签名的随机串
                                    signature: data.signature,
                                    jsApiList: [
                                        "onMenuShareTimeline",
                                        "onMenuShareAppMessage",
                                        "onMenuShareQQ",
                                        "onMenuShareWeibo",
                                        "onMenuShareQZone"
                                    ]
                                });
                                wx.ready(function () {
                                    //分享给朋友圈
                                    wx.onMenuShareTimeline({
                                        title: sharetitle, // 分享标题
                                        link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                        imgUrl: shareimg, // 分享图标
                                        success: function () {
                                            // 用户确认分享后执行的回调函数
                                        },
                                        cancel: function () {
                                            // 用户取消分享后执行的回调函数
                                        }
                                    });
                                    //分享给朋友
                                    wx.onMenuShareAppMessage({
                                        title: sharetitle, // 分享标题
                                        desc: sharedesc, // 分享描述
                                        link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                        imgUrl: shareimg, // 分享图标
                                        type: '', // 分享类型,music、video或link，不填默认为link
                                        dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                                        success: function () {
                                            // 用户确认分享后执行的回调函数
                                        },
                                        cancel: function () {
                                            // 用户取消分享后执行的回调函数
                                        }
                                    });
                                });
                            },
                            error: function (xhr, type) {
                                //alert(111);
                            }
                        })
                    }

                }, function () {
                    console.info('error');
                });

            },
            methods: {

                submit: function (id, b) {
                    if (device == "ios" || device == "android") {
                        var $this = this;
                        //app交互——获取登录状态
                        ft.isLogin(function (result) {
                            var errorcode = result.errorCode.toString();
                            if (errorcode == "1") {
                                //$api.toast('登陆成功', 2000);
                                userid = result.data.userId.toString();
                                window.userid = userid;
                                //alert("userid"+userid);
                                //积分兑换
                                if ($this.count == 0) {
                                    alert("请先选择商品!");
                                    return;
                                }
                                $("body").append(
                                    '<div id="mask" class="mask works-mask">' +
                                    '<div class="mask-content">' +
                                    '<p class="del-p">您确定要删除图片吗？</p>' +
                                    '<p class="check-p">' +
                                    '<span class="del-com wsdel-ok">确定</span>' +
                                    '<span class="wsdel-no">取消</span>' +
                                    '</p></div></div>');
                                $("#mask").css("display", "block");
                                $(".wsdel-ok").click(function () {
                                    $("#mask").css("display", "none");
                                    $this.userId = userid;
                                    $this.getAddress(this.userId);
                                });
                                $(".wsdel-no").click(function () {
                                    $("#mask").css("display", "none");
                                })

                            } else if (errorCode == "0") {
                                $api.toast('登陆取消', 2000);
                            } else if (errorCode == "-1") {
                                $api.toast('登陆失败', 2000);
                            } else if (errorCode == "-2") {
                                $api.toast('登陆不支持', 2000);
                            }
                        });
                        //积分兑换
//                  if ($this.count == 0) {
//                      alert("请先选择商品!");
//                      return;
//                  }
//                  userid = 120374;
//                  var flag = confirm("确认兑换该商品吗？");
//                  if (!flag)return;
//                  var $this = this;
//                  this.userId = userid;
//                  this.getAddress(this.userId);
                    } else if ((device == null)) {
                        window.location.href = "https://t.growingio.com/app/at2/xogaz2Rm_o";
                    }
                },
                getAddress: function (userId, back) {
                    var $this = this;
                    this.$http.post(urlport + 'receiptAddress/default', {"userId": this.userId}).then(function (data) {
                        console.log(data.data.data);
                        if (data.data.data == null) {
                            alert("请先编辑收货地址！");
                            return;
                        }
                        $this.receiptAddress = data.data.data.id;
                        console.info($this.receiptAddress);
                        $this.submitFn($this.receiptAddress);
                    }, function (err) {

                    });
                },
                submitFn: function (address) {
                    var $this = this;
                    this.$http.post(urlport + 'order/createByIntegral', {
                        'userId': $this.userId,
                        'receiptAddressId': address,
                        'productId': $this.dataAll.id,
                        'count': $this.count,
                        'classId': $this.merchandiseClasses

                    }).then(function (data) {
                        //alert(JSON.stringify(data.body.status));
                        console.log(JSON.stringify(data.body.status));
                        if (data.body.status == 408) {
                            alert('余额不足！');
                            return;
                        } else {
                            alert('兑换成功！');
                        }
                    }, function (err) {
                    });
                },
                selectType: function (classid, stock, paidIntegral, integral, item, count, inventory, totalntegral) {
                    var $this = this;
                    //console.info(item);
                    $this.merchandiseClasses = classid;
                    $this.stock = stock;
                    $this.payintegral = paidIntegral;
                    paidintegral = $this.payintegral;
                    $this.integral = integral;
                    $this.count = 1;
                    if (stock > 0) {//库存不为0时数量初始值为1
                        $this.count = 1;
                        $this.totalntegral = paidIntegral;
                    } else {//库存为0时数量初始值为0
                        $this.count = 0;
                        $this.totalntegral = 0;
                    }

                },
                changeNum: function (type, totalntegral) {
                    if (this.stock == 0) {
                        alert("库存不足!");
                        return;
                    }
                    if (type == 0) {
                        this.count = this.count - 1 > 1 ? this.count - 1 : 1;
//                        this.totalntegral = paidintegral * this.count;
                    } else {
                        this.count = this.count + 1 > this.stock ? this.stock : this.count + 1;
//                        this.totalntegral = paidintegral * this.count;
                    }
                },
//                selectSku: function (uuid, stock, price, item, count, description, image, name, productUuid) {
//                    var $this = this;
//                    //console.info(item);
////                    $this.uuid = uuid;
//                    $this.stock = stock;
//                    $this.price = price;
////                    $this.image = image;
////                    $this.name = name;
////                    $this.inventory = inventory;
////                    $this.productUuid = productUuid;
////                    $this.description = description;
//                    $this.count = 1;
//                    if (stock > 0) {//库存不为0时数量初始值为1
//                        $this.count = 1;
//                        $this.totalntegral = paidIntegral;
//                    } else {//库存为0时数量初始值为0
//                        $this.count = 0;
//                        $this.totalntegral = 0;
//                    }
//
//                },

            }
        });

        $.loadComment({"pageNum": 1, "pageSize": 10, "type": 10, "refId": parseInt(id), "userId": parseInt(userid)}, 1);
    }

</script>


</body>
</html>