<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <!-- 这是个iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览；-->
  <meta content="yes" name="apple-mobile-web-app-capable">
  <!-- 全屏显示-->
  <meta content="yes" name="apple-touch-fullscreen">
  <!-- 不要让设备识别电话号码和邮箱地址-->
  <meta content="telephone=no,email=no" name="format-detection">
  <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport" name="viewport">
  <!-- DNS预解析-->
  <meta content="on" http-equiv="x-dns-prefetch-control">
  <title>核销卡券</title>
</head>
<body>

<script src='../js/lib.js' type="text/javascript"></script>
<script>
  
  function GetQueryString(name) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    var r = window.location.search.substr(1).match(reg);
    if (r != null) return unescape(r[2]);
    return null;
  }

  console.log(window.location);
  // var voucherno = GetQueryString("voucherno");
  var code = GetQueryString("code");
  var datastr = GetQueryString("datastr");
  // alert(decodeURIComponent(datastr));
  console.log(datastr);
  var str = unescape(datastr);
  console.log(str);
  var obj = eval('(' + str + ')');
  console.log(obj);
  var password = unescape(obj.password);
  var coderemark = unescape(obj.coderemark);
  var voucherno = unescape(obj.voucherno);
  console.log({
    "coderemark": coderemark,
    "password": password,
    "voucherno": voucherno,
    "code": code
  });
  // alert(JSON.stringify({
  //   "coderemark": coderemark,
  //   "password": password,
  //   "voucherno": voucherno,
  //   "code": code
  // }));
  


  //三方登录接口
  $.ajax({
    type: 'POST',
    url: urlport + "pay/wxtoken",
    datatype: "json",
    data: JSON.stringify({
      code: code
    }),
    contentType: 'application/json;charset=UTF-8',
    success: function (obj) {
      console.log(obj);
      alert(JSON.stringify(obj));
      if (obj.status == 200) {
        var data = obj.data;
        /*token信息*/
        var access_token = data.wxtoken.access_token;
        var refresh_token = data.wxtoken.refresh_token;
        var expires_in = data.wxtoken.expires_in;
        var openid = data.wxtoken.openid;
        var scope = data.wxtoken.scope;
        var unionid = data.wxtoken.unionid;
        /*用户信息*/
        var nickname = data.wxinfo.nickname;
        var sex = data.wxinfo.sex;
        var province = data.wxinfo.province;
        var city = data.wxinfo.city;
        var country = data.wxinfo.country;
        var headimgurl = data.wxinfo.headimgurl;
        var privilege = data.wxinfo.privilege;
  
        console.log({
          "applyRemark": coderemark,
          "applySecret": password,
          "voucherNo": voucherno,
          "applyWx": data.wxinfo.nickname,
          "applyWxid": data.wxtoken.openid
        });
  
        alert(JSON.stringify({
          "applyRemark": coderemark,
          "applySecret": password,
          "voucherNo": voucherno,
          "applyWx": data.wxinfo.nickname,
          "applyWxid": data.wxtoken.openid
        }));
        $.ajax({
          type: 'POST',
          url: urlport + "voucher/applyVoucherNo",
          datatype: "json",
          data: JSON.stringify({
            "applyRemark": coderemark,
            "applySecret": password,
            "voucherNo": voucherno,
            "applyWx": data.wxinfo.nickname,
            "applyWxid": data.wxtoken.openid
          }),
          contentType: 'application/json;charset=UTF-8',
          success: function (data) {
            alert(JSON.stringify(data));
            var data = data.data;
            alert(data.errorMessage)
          }
        });
      } else {
        alert(JSON.stringify(data));
        alert(obj.errorMessage);
      }
    
    }
  });

</script>
</body>
</html>