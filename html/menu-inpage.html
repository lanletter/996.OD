<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <!-- 这是个iphone设备中的safari私有meta标签，它表示：允许全屏模式浏览；-->
    <meta content="yes" name="apple-mobile-web-app-capable">
    <!-- 全屏显示-->
    <meta name="apple-touch-fullscreen" content="yes">
    <!-- 不要让设备识别电话号码和邮箱地址-->
    <meta content="telephone=no,email=no" name="format-detection">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" id="viewport"
          name="viewport">
    <!-- DNS预解析-->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <!--<link href="../css/common/reset.css" rel="stylesheet">-->
    <link href="../css/common.css" rel="stylesheet">
    <link href="../css/animate.css" rel="stylesheet">
    <link href="../css/jf-info.css" rel="stylesheet">
    <link href="../css/menu-inpage.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../css/video-js.min.css">
    <link rel="stylesheet" type="text/css" href="../css/ftcomment.css">
    <title>菜谱内页</title>
    <script type='text/javascript'>
        var _vds = _vds || [];
        window._vds = _vds;
        (function(){
            _vds.push(['setAccountId', '80624a28abff7348']);
            (function() {
                var vds = document.createElement('script');
                vds.type='text/javascript';
                vds.async = true;
                vds.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'dn-growing.qbox.me/vds.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(vds, s);
            })();
        })();
    </script>
</head>
<body>
<div id="videobox" class="video">
    <video id="vd" controls="controls" preload="auto"
           webkit-playsinline="true" playsinline="true" x-webkit-airplay="true" x5-video-player-type="h5"
           x5-video-player-fullscreen="true" x5-video-ignore-metadata="true" src="">
        <source type="video/mp4">
    </video>
    <button class="play"></button>
    <div class="smartLabel" style="display: none;">智能菜谱</div>
</div>
<div class="jf-buy menupage" v-cloak>
    <!--<div v-if="data.video" class="focus" style="height:18.75rem;z-index: 999999;">-->
    <!--<div class="playbox">-->
    <!--<video id="video" width="100%" controls="true" :poster="data.picture">-->
    <!--<source :src="data.video" type="video/mp4"/>-->
    <!--Your browser does not support HTML5 video.-->
    <!--</video>-->
    <!--<div id="play" class="play" @click="play"></div>-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="focus" v-else>-->
    <!--&lt;!&ndash;             <img :src="data.images[0]" alt=""> &ndash;&gt;-->
    <!--<mt-swipe :auto="4000">-->
    <!--<mt-swipe-item v-for="item in data.images">-->
    <!--<img :src="item" alt="">-->
    <!--</mt-swipe-item>-->

    <!--</mt-swipe>-->
    <!--</div>-->
    <div class="title">
        <h4 v-html="data.name"></h4>
        <div style="display: none" id="userid"></div>
        <p class="icons">
            <span><i class="icon-broswer"></i> <b v-html="data.pageviews"></b></span>
            <span><i class="" id="star" @click="star"></i> <b v-html="data.collect_count || 0"></b></span>
        </p>
        <div class="text">
            <h5><span>来源</span></h5>
            <div class="users" v-for="item in data.users">
                <ul class="from h_box">
                    <li class="flex_1">
                        <img :src="item.picturePath" alt=""> <span v-html="item.name"></span>
                    </li>
                    <!--                     <li class="flex_1 t-r">
                                            <span class="attention" @click="atten" :class="{ gray: isgray }">关注</span>
                                        </li> -->
                </ul>
                <p class="desc" v-html="item.desc"></p>
            </div>
            <p class="instructions" v-show="data.instructions !== null" v-html="data.instructions "></p>
            <ul class="h_box special">
                <li>
                    <i class="icon-easy"></i><span><b></b><br/><em>难易程度</em></span>
                </li>
                <li><i class="icon-time"></i>
                    <span><b class="timenum"></b><b class="timetype">分钟</b><br/><em>预计耗时</em></span>
                </li>
                <li><i class="icon-num"></i><span><b></b>人<br/><em>适宜人数</em></span></li>
            </ul>
        </div>

        <div class="qingdan">
            <dl>
                <dt class="tit">
                    <span class="txt"><i class="icon-1"></i>材料清单</span>
                    <!--<span class="addin fr">加入购物车</span>-->
                </dt>
                <dd v-for="item in data.major_ingredients">
                    <!--<span class="type">{{item.type}}</span>-->
                    {{item.name}}
                    <span>{{item.unit}}</span>
                </dd>
                <!--<div class="box"></div>-->
                <!-- <div class="tobuy"><span class="menubtn">一键购买</span></div> -->
            </dl>
        </div>
    </div>

	<div class="step" id="ready_steps">
        <div class="stepbox" v-for="(item,index) in data.ready_steps" track-by="$index">
            <h4>准备步骤 <em><span v-html="index + 1"></span>/<span v-html="data.ready_steps.length"></span></em></h4>
            <img v-show="item.images[0] !== ''" v-for="ite in item.images" :src="ite" alt="">
            <p class="txt" v-show="item.description !== undefined && item.descriptionText!==''" v-html="item.description"></p>
            <!--<p class="txt" v-show="item.descriptionText" v-html="item.descriptionText"></p>-->
            <div class="introduc" v-if="item.reminderText !== ''" v-show="item.reminder">
                <i class="icon-tips"></i>小贴士：<span v-html="item.reminder"></span>
            </div>
            <!--<div class="introduc" v-if="item.reminderText" v-show="item.reminderText">-->
            <!--<i class="icon-tips"></i>小贴士：<span v-html="item.reminderText"></span>-->
            <!--</div>-->
        </div>
    </div>
    <div class="step" id="cooking_steps">
        <div class="stepbox" v-for="(item,index) in data.cooking_steps" track-by="$index">
            <h4>制作步骤 <em><span v-html="index + 1"></span>/<span v-html="data.cooking_steps.length"></span></em></h4>
            <img v-show="item.images[0] !== ''" v-for="ite in item.images" :src="ite" alt="">
            <p class="txt" v-show="item.description !== undefined && item.descriptionText!==''" v-html="item.description"></p>
            <div class="introduc" v-if="item.reminderText !== ''" v-show="item.reminder">
                <i class="icon-tips"></i>小贴士：<span v-html="item.reminder"></span>
            </div>
        </div>
    </div>
    <div class="step" id="end_steps">
        <div class="stepbox" v-for="(item,index) in data.end_steps" track-by="$index">
            <h4>结束步骤 <em><span v-html="index + 1"></span>/<span v-html="data.end_steps.length"></span></em></h4>
            <img v-show="item.images[0] !== ''" v-for="ite in item.images" :src="ite" alt="">
            <p class="txt" v-show="item.description !== undefined && item.descriptionText!==''" v-html="item.description"></p>
            <div class="introduc" v-if="item.reminderText !== ''" v-show="item.reminder">
                <i class="icon-tips"></i>小贴士：<span v-html="item.reminder"></span>
            </div>
        </div>
    </div>
    <div class="equipment" id="devices">
        <h5>智能设备<br/><em>(选择厨具并开始烹饪)</em></h5>
        <ul class="h_box">
            <li class="flex_1" v-for="item in data.devices">
                <a id="callKitchenware" @click="callKitchenware">
                    <img :src="item.picturePath" alt="">
                    <p v-html="item.name"></p>
                </a>
            </li>
        </ul>
    </div>
    <div class="jiange">
    </div>
    <div id="photograph">
        <div class="camera">
            <img src="../img/photograph4.png">
        </div>
        <div class="txt">
            <h5 class="txt1">菜谱学会了吗？来拍照炫耀一下吧</h5>
            <p class="txt2">您可以在下方的评论模块发表您的心得体会</p>
        </div>
    </div>

    <!--<div class="bottomdiv"></div>-->
    <!--<div class="menutype" id="classification" style="display: block;">-->
        <!--<h3>菜谱分类-->
            <!--&lt;!&ndash;<a class="fr" href="">全部分类</a>&ndash;&gt;-->
        <!--</h3>-->
        <!--<div class="typebox">-->
            <!--<a v-for="item in data.classification">-->
            		<!--<span v-html="item.sub.name"></span>-->
            <!--</a>-->
        <!--</div>-->
    <!--</div>-->

    <!--<div class="menutype" style="border:none;" id="kitchenwares">-->
    <!--<h3>厨具列表-->
    <!--&lt;!&ndash;<a class="fr" href="">更多</a>&ndash;&gt;-->
    <!--</h3>-->
    <!--<ul class="list h_box">-->
    <!--<li class="flex_1" v-for="item in data.kitchenwares">-->
    <!--&lt;!&ndash;<a :href="item.url">&ndash;&gt;-->
    <!--<img :src="item.picturePath" alt="">-->
    <!--<p v-text="item.name" style="text-align: center;"></p>-->
    <!--&lt;!&ndash;</a>&ndash;&gt;-->
    <!--</li>-->
    <!--</ul>-->
    <!--</div>-->

    <div class="bottomdiv"></div>
    <div class="ft-comment"></div>
    <!--<div id="loading"></div>-->
</div>


<script src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
<script type="text/javascript" src='../js/lib.js'></script>
<script type="text/javascript" src='../js/api.js'></script>
<script type="text/javascript" src='../js/loadcomment.js'></script>
<script src="../js/vue.min.js"></script>
<script src="../js/vue-resource1.3.4.js"></script>
<script type="text/javascript" src='../js/video.min.js'></script>
<script type="text/javascript" src='../js/ft.js'></script>
<script type="text/javascript" src='../js/judge.js'></script>
<script type="text/javascript" src='../js/jquery.cookie.js'></script>
<script src="../js/alertdiy.js"></script>
<script src="../js/url.js"></script>

<script>
    /*获取url*/
    function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null)return unescape(r[2]);
        return null;
    }
    var id = GetQueryString("id")
    var device = GetQueryString("device");
    if (device == "ios" || device == "android") {
        var userid;
        //app交互—获取userid
        window.onload = function () {
            ft.isLogin2(function (result) {
                var errorcode = result.errorCode.toString();
                //alert(errorcode);
                console.log(errorcode);
                if (errorcode == "1") {
                    userid = result.data.userId.toString();
                    choose();
                } else if (errorCode == "0") {
                } else if (errorCode == "-1") {
                } else if (errorCode == "-2") {
                }
            });
        };
    } else {
        var userid = 1;
        choose();
    }

    function choose() {

        var vm = new Vue({
            el: '.menupage',
            data: {
                data: {},
                isgray: false,
                isshow: false
            },
            created: function () {
                var $this = this;
                this.$http.post(urlport + 'menu/detail', {"id": id, "userId": userid}).then(function (data) {
                    var data = data.data;
                    console.log(data);
                    if (data.status == 200) {
                        //console.info(data);
                        $this.data = data.data;
                        id = $this.data.id;
                    }
                    $(".icon-easy").next("span").find("b").text(data.data.properties.difficulty);
                    $(".icon-time").next("span").find(".timenum").text(data.data.properties.cooking_time);
                    $(".icon-time").next("span").find(".timetype").text(data.data.properties.time_unit);
                    $(".icon-num").next("span").find("b").text(data.data.fit_number);
                    /*判断是否有播放器*/
                    if (data.data.video == null || data.data.video == "") {
                        $(".play").css("display", "none");
                    } else {
                        $('#videobox').find('#vd').attr('src', data.data.video);
                    }
                    /*判断是否有智能标签*/
                    if (data.data.type == 2) {
                        $(".smartLabel").css("display", "block");
                    } else {
                        $(".smartLabel").css("display", "none");
                    }
                    /*头图*/
                    $(".video").css("background-image", 'url("' + data.data.images[0] + '")');


                    /*播放器*/
                    (function () {
                        var video = $('#videobox video')[0],
                                playBtn = $('#videobox .play');
                        playBtn.on('click', function () {
                            $(this).hide();
                            var vheight = $("#videobox video").height();
                            $('#vd').css({"position": "absolute", "left": "0"});
                            $('#videobox').css({"position": "fixed"});
//            $("#videobox").animate({height: vheight - 1 + "px",}, 1000);
//            $(".jf-buy").animate({top: vheight - 1,}, 1000);
                            $("#videobox").css({height: vheight - 1 + "px",});
                            $(".jf-buy").css({top: vheight - 1,});
                            $(".smartLabel").hide();
                            video.play();
                            video.controls = true;
                        });

                        video.addEventListener('ended', function () {
                            playBtn.show();
                            video.controls = false;
                            $('#vd').css({"position": "absolute", "left": "-10rem"});
                            $('#videobox').css({"position": "absolute"});
//            $("#videobox").animate({"height": "10rem"}, 1000);
//            $(".jf-buy").animate({"top": "10rem"}, 1000);
                            $("#videobox").css({"height": "10rem"});
                            $(".jf-buy").css({"top": "10rem"});
                            if (data.data.type == 2) {$(".smartLabel").show();}
                        }, false);
                        video.addEventListener('pause', function () {
                            playBtn.hide();
                            video.controls = true;
                        }, false);
                    })();

                    /*判断是否收藏*/
                    if (userid == 1 || userid == "1") {
                        $("#star").addClass("icon-msg");
                        $("#star").remove("icon-msg2");
                    } else {
                        if (data.data.isFavorite == 1) {
                            $("#star").addClass("icon-msg2");
                            $("#star").remove("icon-msg");
                        } else {
                            $("#star").addClass("icon-msg");
                            $("#star").remove("icon-msg2");
                        }
                    }
                    /*判断是否有来源*/
                    if (data.data.users.length == 0) {
                        $(".text h5").css("display", "none");
                    }
                    if (data.data.devices.length == 0) {
                        $("#devices").css("display", "none");
                        $(".jiange:eq(0)").remove();
                    }
                    if (data.data.classification.length == 0) {
                        $("#classification").css("display", "none");
                        $("#classification").prev(".bottomdiv").css("display", "none");
                    }
//                if(ata.data.kitchenwares.length==0){
//                    $("#kitchenwares").css("display", "none");
//                }
                   if(data.data.ready_steps[0].descriptionText=="" && data.data.ready_steps[0].images[0]==""){
                        $("#ready_steps").css("display", "none");
                    }
                    if(data.data.cooking_steps[0].descriptionText=="" && data.data.cooking_steps[0].images[0]==""){
                        $("#cooking_steps").css("display", "none");
                    }
                    if(data.data.end_steps[0].descriptionText=="" && data.data.end_steps[0].images[0]==""){
                        $("#end_steps").css("display", "none");
                    }

                    $(".instructions").html(data.data.instructions);
                    /*微信分享链接专用*/
                    var sharetitle = data.data.name;
                    var sharedesc;
                    var contents = $(".instructions").text().replace(/[\r\n]/g, "").replace(/(^\s+)|(\s+$)/g, "").replace(/\s/g, "");
                    var count = contents.length;
                    if (count > 40) {
                        var nr = contents.substring(0, 40) + "...";
                        sharedesc = nr;
                    } else {
                        sharedesc = contents;
                    }
                    var shareimg = data.data.images[0];
                    var sharestr = data.data.url;
                    var sharelink = sharestr.replace(/api/, "h5");
                    console.log(sharetitle + "|" + shareimg + "|" + sharelink + "|" + sharedesc);
                    $.ajax({
                        type: 'GET',
                        url: urlport + 'wx/wxConfig.json?url=' + encodeURIComponent(window.location.href.split('#')[0]),
                        success: function (data) {
                            console.info(data.appId);
                            wx.config({
                                debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                                appId: data.appId, // 必填，公众号的唯一标识
                                timestamp: data.timestamp, // 必填，生成签名的时间戳
                                nonceStr: data.nonceStr, // 必填，生成签名的随机串
                                signature: data.signature,
                                jsApiList: [
                                    "onMenuShareTimeline",
                                    "onMenuShareAppMessage",
                                    "onMenuShareQQ",
                                    "onMenuShareWeibo",
                                    "onMenuShareQZone"
                                ]
                            });
                            wx.ready(function () {
                                //分享给朋友圈
                                wx.onMenuShareTimeline({
                                    title: sharetitle, // 分享标题
                                    link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                    imgUrl: shareimg, // 分享图标
                                    success: function () {
                                        // 用户确认分享后执行的回调函数
                                    },
                                    cancel: function () {
                                        // 用户取消分享后执行的回调函数
                                    }
                                });
                                //分享给朋友
                                wx.onMenuShareAppMessage({
                                    title: sharetitle, // 分享标题
                                    desc: contents, // 分享描述
                                    link: sharelink, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                                    imgUrl: shareimg, // 分享图标
                                    type: '', // 分享类型,music、video或link，不填默认为link
                                    dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
                                    success: function () {
                                        // 用户确认分享后执行的回调函数
                                    },
                                    cancel: function () {
                                        // 用户取消分享后执行的回调函数
                                    }
                                });
                            });
                        },
                        error: function (xhr, type) {
                            //alert(111);
                        }
                    })
                }, function () {
                    console.info('error');
                });

            },
            methods: {
                atten: function () {
                    if (this.isgray)return;
                    this.isgray = true;
                    console.info(11);
                },
                play: function (obj) {
                    var obj = document.getElementById("video");
                    obj.play();
                    document.getElementById("play").style.display = 'none';
                    obj.controls = true;
                    obj.addEventListener('ended', function () {
                        document.getElementById("play").style.display = 'block';
                        obj.controls = false;
                    });
                    obj.addEventListener('pause', function () {
                        document.getElementById("play").style.display = 'block';
                        obj.controls = false;
                    });
                    //console.info(55);
                },
                callKitchenware: function (obj) {
                    //app交互——唤起智能菜谱
                    // $("#callKitchenware").on("click", function () {
                    //alert("111");
                    ft.callKitchenware(function (result) {

                    });
                    //});
                },
                star: function (obj) {
                    //alert("id:"+id+"type:"+1+"userid:"+userid);
//                    var follow = $("#star").attr('class');
//                    if (follow == "icon-msg") {
//                        $api.post(urlport + 'favorite/create', {
//                            "refId": id,
//                            "type": 1,
//                            "userId": userid
//                        }, function (data) {
//                            console.log(data);
//                            console.log("111");
//                            $("#star").addClass("icon-msg2");
//                            $("#star").removeClass("icon-msg");
//                            var oldnum = $("#star").next().text();
//                            $("#star").next().text(parseInt(oldnum) + 1);
//                            $api.toast('收藏成功！', 3000);
//                        });
//                    } else if (follow == "icon-msg2") {
//                        $api.post(urlport + 'favorite/cancel', {
//                            "refId": id,
//                            "type": 1,
//                            "userId": userid
//                        }, function (data) {
//                            console.log(data);
//                            console.log("222");
//                            $("#star").addClass("icon-msg");
//                            $("#star").removeClass("icon-msg2");
//                            var oldnum = $("#star").next().text();
//                            $("#star").next().text(parseInt(oldnum) - 1);
//                            $api.toast('取消收藏！', 3000);
//                        });
//                    }
                    //app交互——获取登录状态
                    ft.isLogin(function (result) {
                        var errorcode = result.errorCode.toString();
                        if (errorcode == "1") {
                            //$api.toast('登陆成功', 2000);
                            userid = result.data.userId.toString();
                            //alert(userid);
                            //收藏
                            var follow = $("#star").attr('class');
                            if (follow == "icon-msg") {
                                $api.post(urlport + 'favorite/create', {
                                    "refId": id,
                                    "type": 1,
                                    "userId": userid
                                }, function (data) {
                                    console.log(data);
                                    console.log("111");
                                    $("#star").addClass("icon-msg2");
                                    $("#star").removeClass("icon-msg");
                                    var oldnum = $("#star").next().text();
                                    $("#star").next().text(parseInt(oldnum) + 1);
                                    $api.toast('收藏成功！', 3000);
                                });
                            } else if (follow == "icon-msg2") {
                                $api.post(urlport + 'favorite/cancel', {
                                    "refId": id,
                                    "type": 1,
                                    "userId": userid
                                }, function (data) {
                                    console.log(data);
                                    console.log("222");
                                    $("#star").addClass("icon-msg");
                                    $("#star").removeClass("icon-msg2");
                                    var oldnum = $("#star").next().text();
                                    $("#star").next().text(parseInt(oldnum) - 1);
                                    $api.toast('取消收藏！', 3000);
                                });
                            }
                        } else if (errorCode == "0") {
                            $api.toast('登陆取消', 2000);
                        } else if (errorCode == "-1") {
                            $api.toast('登陆失败', 2000);
                        } else if (errorCode == "-2") {
                            $api.toast('登陆不支持', 2000);
                        }
                    });

                }

            }
        });

        if(id.length>5){
            $(".ft-comment").css("display", "none");
        }
        $.loadComment({"pageNum": 1, "pageSize": 10, "refId": parseInt(id), "type": 1, "userId": parseInt(userid)}, 1);

    }

</script>


</body>
</html>